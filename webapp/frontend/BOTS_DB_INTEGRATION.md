# Интеграция страницы управления ботами с базой данных

## Обзор

Страница управления ботами (`/bots`) теперь полностью интегрирована с PostgreSQL базой данных. Все операции CRUD работают с реальными данными из таблицы `bot`.

## Установка зависимостей

Убедитесь, что установлены необходимые пакеты:

```bash
npm install pg
npm install --save-dev @types/pg
```

## Настройка переменных окружения

Создайте файл `.env.local` в директории `webapp/frontend/` (или добавьте в существующий `.env`):

```env
DATABASE_URL=postgresql://username:password@localhost:5432/database_name
```

**Важно:** `DATABASE_URL` должен быть доступен на сервере Next.js (в API routes), но не должен быть экспортирован в клиентский код.

## Структура базы данных

Интеграция использует следующие таблицы:

### Таблица `bot`
- `bot_id` (PK) - уникальный идентификатор бота
- `account_id` (FK) - идентификатор аккаунта (мультитенантность)
- `bot_name` - имя бота (уникально в рамках аккаунта)
- `bot_token` - Telegram bot token (уникален глобально)
- `display_name` - отображаемое имя
- `description` - описание бота
- `is_active` - флаг активности
- `created_at`, `updated_at` - временные метки
- `settings` - JSONB с дополнительными настройками

## API Endpoints

### GET /api/bots
Возвращает список всех ботов для текущего аккаунта.

**Ответ:**
```json
{
  "bots": [
    {
      "bot_id": 1,
      "account_id": 1,
      "bot_name": "my_bot",
      "bot_token": "••••••••••••••••••",
      "display_name": "My Bot",
      "description": "Bot description",
      "is_active": true,
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

**Примечание:** Токены автоматически маскируются для безопасности.

### POST /api/bots
Создает нового бота.

**Тело запроса:**
```json
{
  "bot_token": "123456789:ABCdefGHIjklMNOpqrsTUVwxyz",
  "bot_name": "my_bot",
  "display_name": "My Bot",
  "description": "Optional description",
  "is_active": true
}
```

**Ответ:** 201 Created с данными созданного бота.

**Ошибки:**
- 400 - Неверный запрос (отсутствуют обязательные поля)
- 409 - Конфликт (бот с таким именем или токеном уже существует)

### GET /api/bots/[botId]
Возвращает детали конкретного бота.

**Ответ:** Объект бота или 404 если не найден.

### PATCH /api/bots/[botId]
Обновляет настройки бота.

**Тело запроса (все поля опциональны):**
```json
{
  "display_name": "Updated Name",
  "description": "Updated description",
  "is_active": false,
  "settings": {}
}
```

**Ответ:** Обновленный объект бота.

## Безопасность

1. **Маскирование токенов:** Все токены автоматически маскируются при возврате из API (кроме случаев, когда нужен реальный токен для операций).

2. **Мультитенантность:** Все запросы фильтруются по `account_id`. Функция `getAccountId()` должна быть реализована для получения account_id из сессии/токена аутентификации.

3. **Валидация:** Все входные данные валидируются перед записью в БД.

## Утилита для работы с БД

Файл `lib/db.ts` предоставляет:

- `query<T>(text, params)` - выполнение SQL запроса с возвратом массива строк
- `queryOne<T>(text, params)` - выполнение SQL запроса с возвратом одной строки
- `getAccountId(request)` - получение account_id из контекста запроса (TODO: реализовать аутентификацию)
- `closePool()` - закрытие пула подключений

## Интеграция с Telegram API

Endpoint `/api/telegram/getMe` теперь вызывает реальный Telegram Bot API для валидации токенов:

- Вызывает `https://api.telegram.org/bot{token}/getMe`
- Получает информацию о боте (имя, username, ID)
- Опционально получает фото профиля бота
- Возвращает структурированные данные

## TODO

1. **Аутентификация:** Реализовать функцию `getAccountId()` для получения account_id из JWT токена или сессии.

2. **Шифрование токенов:** В продакшене токены ботов должны храниться в зашифрованном виде.

3. **Кэширование:** Добавить кэширование для часто запрашиваемых данных (список ботов).

4. **Telegram Info:** Создать endpoint для получения актуальной информации о боте из Telegram API (аватар, команды, описание).

5. **Обработка ошибок:** Улучшить обработку ошибок БД и Telegram API.

6. **Логирование:** Добавить структурированное логирование всех операций.

## Тестирование

Для тестирования убедитесь, что:

1. PostgreSQL запущен и доступен
2. `DATABASE_URL` правильно настроен
3. Таблица `bot` существует и заполнена тестовыми данными
4. Можно подключиться к БД из Node.js окружения

## Миграции

Убедитесь, что выполнены миграции для создания таблиц:
- `migrations/versions/0003_migrate_to_saas.sql` - создает таблицу `bot`
