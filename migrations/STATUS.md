# –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π

## ‚úÖ –ì–æ—Ç–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### 0001_create_schema_migrations.sql
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `schema_migrations`
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è
- ‚úÖ –ì–æ—Ç–æ–≤–∞ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

### 0002_baseline_current_schema.sql
- ‚úÖ –°–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—É—â—É—é —Å—Ö–µ–º—É –ë–î
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è (IF NOT EXISTS)
- ‚úÖ –ì–æ—Ç–æ–≤–∞ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏: —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ö–µ–º–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–µ–π –ë–î

### 0003_migrate_to_saas.sql
- ‚úÖ –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∫ SaaS –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è (–ø—Ä–æ–≤–µ—Ä–∫–∏ IF NOT EXISTS)
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ Rollback —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω
- ‚úÖ –ì–æ—Ç–æ–≤–∞ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

## üìã –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

```bash
# 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–¥–µ–ª–∞–Ω–æ)
./migrations/tools/init_history.sh

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
./migrations/tools/status.sh

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
./migrations/tools/migrate.sh

# –ò–ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ –æ–¥–Ω–æ–π:
# ./migrations/tools/migrate.sh --to 0001
# ./migrations/tools/migrate.sh --to 0002
# ./migrations/tools/migrate.sh --to 0003
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ü–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º 0003_migrate_to_saas.sql:

1. **–°–æ–∑–¥–∞–π—Ç–µ –±—ç–∫–∞–ø:**
   ```bash
   pg_dump -d profochatbot -F c -f backup_before_saas_$(date +%Y%m%d_%H%M%S).dump
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—É—â—É—é —Å—Ö–µ–º—É:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `0002_baseline_current_schema.sql` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ö–µ–º–µ
   - –ï—Å–ª–∏ –Ω–µ—Ç - –æ–±–Ω–æ–≤–∏—Ç–µ baseline –º–∏–≥—Ä–∞—Ü–∏—é

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
   - –û—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `botname` –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö `run` –∏ `course`

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ –Ω–∞ production

### –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è 0003_migrate_to_saas.sql:

1. **–û–±–Ω–æ–≤–∏—Ç–µ bot tokens:**
   ```sql
   UPDATE bot SET bot_token = '<token>' WHERE bot_name = '<name>';
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:**
   ```sql
   -- –í—Å–µ runs –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å bot_id
   SELECT COUNT(*) FROM run WHERE bot_id IS NULL;
   
   -- –í—Å–µ runs –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å deployment_id (–µ—Å–ª–∏ –µ—Å—Ç—å –∫—É—Ä—Å)
   SELECT COUNT(*) FROM run WHERE course_id IS NOT NULL AND deployment_id IS NULL;
   ```

3. **–û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
   - –ó–∞–º–µ–Ω–∏—Ç–µ `botname` –Ω–∞ `bot_id`
   - –î–æ–±–∞–≤—å—Ç–µ `account_id` –≤ –∑–∞–ø—Ä–æ—Å—ã
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `deployment_id` –¥–ª—è —Å–≤—è–∑–µ–π –∫—É—Ä—Å-–±–æ—Ç

## üîÑ –û—Ç–∫–∞—Ç

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
./migrations/tools/rollback.sh

# –ò–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞
pg_restore -d profochatbot -c backup_before_saas_YYYYMMDD_HHMMSS.dump
```

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

- **–í—Å–µ–≥–æ –º–∏–≥—Ä–∞—Ü–∏–π:** 3
- **–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é:** 3
- **–¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:** 0002 (baseline —Å—Ö–µ–º–∞)

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ baseline —Å—Ö–µ–º—ã —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞ production —Å –±—ç–∫–∞–ø–æ–º
