# Product Requirements Document (PRD)
## ProfoChatBot Web - Веб-версия платформы для интерактивных обучающих курсов

**Версия:** 1.0  
**Дата:** 2024  
**Статус:** Проектирование  
**Базовый документ:** Telegram PRD v1.0

---

## 1. Purpose / Goals

### 1.1 Цель продукта

ProfoChatBot Web — это веб-версия платформы для создания и проведения интерактивных обучающих курсов. Система предоставляет полноценный веб-интерфейс для прохождения курсов с поддержкой различных типов учебных элементов, диалогов с ИИ-ассистентом, отслеживания прогресса и сохранения результатов обучения.

### 1.2 Ключевые цели

**Образовательные цели:**
- Предоставить удобный веб-интерфейс для прохождения обучающих курсов
- Обеспечить персонализацию обучения через диалоги с LLM-ассистентом
- Поддержать различные форматы обучения (текст, видео, PDF, квизы, интерактивные чаты)
- Обеспечить непрерывность обучения с сохранением прогресса

**Технические цели:**
- Реализовать современный веб-интерфейс на Next.js 14 + TypeScript
- Обеспечить RESTful API на FastAPI для взаимодействия frontend и backend
- Использовать PostgreSQL для надежного хранения данных
- Поддержать stateful навигацию и управление состоянием приложения

**UX цели:**
- Интуитивный интерфейс с понятной навигацией
- Отображение прогресса обучения в реальном времени
- Встроенное воспроизведение мультимедиа (видео, аудио, PDF)
- Адаптивный дизайн для различных устройств

---

## 2. User Stories / Use Cases

### 2.1 Основные пользовательские истории

**US-1: Просмотр списка доступных курсов**
- **Как** пользователь  
- **Я хочу** видеть список всех доступных мне курсов  
- **Чтобы** выбрать курс для прохождения

**US-2: Начало прохождения курса**
- **Как** пользователь  
- **Я хочу** начать новый курс одним кликом  
- **Чтобы** начать обучение без дополнительных действий

**US-3: Просмотр урока с различными типами шагов**
- **Как** пользователь  
- **Я хочу** видеть шаги урока (видео, PDF, сообщения, квизы) в удобном формате  
- **Чтобы** эффективно усваивать материал

**US-4: Прохождение квиза**
- **Как** пользователь  
- **Я хочу** отвечать на вопросы квиза прямо в интерфейсе  
- **Чтобы** проверить свои знания и получить обратную связь

**US-5: Диалог с ИИ-ассистентом**
- **Как** пользователь  
- **Я хочу** общаться с ИИ-ассистентом в чате  
- **Чтобы** получить персонализированную помощь в обучении

**US-6: Отслеживание прогресса**
- **Как** пользователь  
- **Я хочу** видеть свой прогресс по курсу  
- **Чтобы** понимать, сколько материала осталось изучить

**US-7: Возобновление обучения**
- **Как** пользователь  
- **Я хочу** продолжить курс с того места, где остановился  
- **Чтобы** не терять прогресс при перерывах

**US-8: Просмотр истории чата**
- **Как** пользователь  
- **Я хочу** видеть историю диалога с ИИ-ассистентом  
- **Чтобы** вернуться к предыдущим обсуждениям

### 2.2 Детальные use cases

**UC-1: Прохождение урока с видео и квизом**

1. Пользователь открывает урок
2. Система отображает шаг типа `video` с встроенным видеоплеером
3. Пользователь просматривает видео
4. После завершения видео автоматически отображается следующий шаг
5. Система показывает шаг типа `quiz_single_choice`
6. Пользователь выбирает ответ
7. Система показывает обратную связь и сохраняет результат
8. Прогресс обновляется

**UC-2: Диалог с LLM-ассистентом**

1. Пользователь достигает шага типа `chat`
2. Система отображает интерфейс чата с начальным сообщением
3. Пользователь вводит вопрос или сообщение
4. Система отправляет запрос в LLM через backend API
5. Backend обрабатывает запрос и возвращает ответ
6. Система отображает ответ в чате
7. Диалог продолжается до завершения (по условию или действию пользователя)
8. История диалога сохраняется в базу данных

**UC-3: Просмотр PDF материала**

1. Пользователь открывает шаг типа `pdf`
2. Система загружает PDF файл
3. PDF отображается во встроенном просмотрщике
4. Пользователь может листать страницы, увеличивать масштаб
5. После просмотра пользователь переходит к следующему шагу

**UC-4: Навигация по курсу**

1. Пользователь видит список уроков курса
2. Пользователь выбирает урок
3. Система загружает шаги урока
4. Пользователь проходит шаги последовательно
5. Система отслеживает текущий шаг
6. Пользователь может вернуться к предыдущим шагам (если разрешено)

---

## 3. Key Concepts

### 3.1 Основные концепции

**Course (Курс)**
- Структурированная последовательность уроков
- Имеет метаданные (название, описание, автор)
- Может быть ограничен по доступу (restricted)

**Lesson (Урок)**
- Единица курса, содержащая последовательность шагов
- Пользователь проходит урок шаг за шагом
- Имеет прогресс прохождения

**LessonStep (Шаг урока)**
- Минимальная единица учебного контента
- Типы: `message`, `video`, `pdf`, `quiz_single_choice`, `chat`
- Выполняется последовательно в рамках урока

**ChatSession (Сессия чата)**
- Сессия диалога с LLM-ассистентом в рамках шага `chat`
- Содержит историю сообщений пользователя и ассистента
- Сохраняется в базе данных для возможности возобновления

**ChatMessage (Сообщение чата)**
- Отдельное сообщение в сессии чата
- Имеет роль: `user` или `assistant`
- Содержит текст и метаданные (время, статус)

**QuizAttempt (Попытка квиза)**
- Результат прохождения квиза пользователем
- Содержит выбранные ответы и оценку
- Сохраняется для отслеживания прогресса

**Progress (Прогресс)**
- Текущее состояние прохождения курса пользователем
- Включает текущий урок, текущий шаг, процент завершения
- Обновляется при каждом взаимодействии

### 3.2 Архитектурные концепции

**Frontend (Next.js 14 + TypeScript)**
- Server-side rendering для начальной загрузки
- Client-side routing для навигации между страницами
- State management для управления состоянием приложения
- API routes для проксирования запросов к backend

**Backend (Python + FastAPI)**
- RESTful API endpoints
- Интеграция с LLM (OpenAI API)
- Работа с базой данных PostgreSQL
- Валидация данных через Pydantic

**Database (PostgreSQL)**
- Хранение пользователей, курсов, уроков, шагов
- Сохранение сессий чата и сообщений
- Хранение попыток квизов и прогресса
- Поддержка транзакций для целостности данных

---

## 4. Entities

### 4.1 Сущности базы данных

#### User (Пользователь)
**Описание:** Пользователь системы, проходящий курсы

**Поля:**
- `user_id` (UUID, PK) - уникальный идентификатор пользователя
- `email` (VARCHAR, UNIQUE) - email пользователя (для аутентификации)
- `username` (VARCHAR) - имя пользователя
- `created_at` (TIMESTAMP) - дата регистрации
- `last_active_at` (TIMESTAMP) - последняя активность

**Связи:**
- Один ко многим с `CourseProgress`
- Один ко многим с `ChatSession`
- Один ко многим с `QuizAttempt`

#### Course (Курс)
**Описание:** Обучающий курс, состоящий из уроков

**Поля:**
- `course_id` (VARCHAR, PK) - идентификатор курса
- `title` (VARCHAR) - название курса
- `description` (TEXT) - описание курса
- `creator_id` (UUID, FK → User) - создатель курса
- `is_restricted` (BOOLEAN) - ограничен ли доступ
- `created_at` (TIMESTAMP) - дата создания
- `updated_at` (TIMESTAMP) - дата обновления

**Связи:**
- Один ко многим с `Lesson`
- Один ко многим с `CourseProgress`

#### Lesson (Урок)
**Описание:** Урок в рамках курса, содержащий шаги

**Поля:**
- `lesson_id` (UUID, PK) - уникальный идентификатор урока
- `course_id` (VARCHAR, FK → Course) - курс, к которому относится урок
- `title` (VARCHAR) - название урока
- `description` (TEXT) - описание урока
- `order_index` (INTEGER) - порядок урока в курсе
- `created_at` (TIMESTAMP) - дата создания

**Связи:**
- Многие к одному с `Course`
- Один ко многим с `LessonStep`
- Один ко многим с `LessonProgress`

#### LessonStep (Шаг урока)
**Описание:** Шаг урока с определенным типом контента

**Поля:**
- `step_id` (UUID, PK) - уникальный идентификатор шага
- `lesson_id` (UUID, FK → Lesson) - урок, к которому относится шаг
- `step_type` (VARCHAR) - тип шага: `message`, `video`, `pdf`, `quiz_single_choice`, `chat`
- `order_index` (INTEGER) - порядок шага в уроке
- `content` (JSONB) - данные шага в формате JSON
- `created_at` (TIMESTAMP) - дата создания

**Структура `content` по типам:**

**`message`:**
```json
{
  "text": "Текст сообщения",
  "parse_mode": "markdown",
  "media": ["url1", "url2"]
}
```

**`video`:**
```json
{
  "video_url": "https://...",
  "title": "Название видео",
  "description": "Описание"
}
```

**`pdf`:**
```json
{
  "pdf_url": "https://...",
  "title": "Название документа"
}
```

**`quiz_single_choice`:**
```json
{
  "question": "Вопрос",
  "options": [
    {"id": "opt1", "text": "Вариант 1", "correct": true},
    {"id": "opt2", "text": "Вариант 2", "correct": false}
  ],
  "feedback_correct": "Правильно!",
  "feedback_incorrect": "Неправильно"
}
```

**`chat`:**
```json
{
  "initial_message": "Начальное сообщение",
  "system_prompt": "Системный промпт для LLM",
  "model": "gpt-4",
  "temperature": 0.7,
  "max_messages": 10
}
```

**Связи:**
- Многие к одному с `Lesson`
- Один ко многим с `ChatSession` (для типа `chat`)
- Один ко многим с `QuizAttempt` (для типа `quiz_single_choice`)

#### CourseProgress (Прогресс по курсу)
**Описание:** Прогресс пользователя по курсу

**Поля:**
- `progress_id` (UUID, PK) - уникальный идентификатор прогресса
- `user_id` (UUID, FK → User) - пользователь
- `course_id` (VARCHAR, FK → Course) - курс
- `current_lesson_id` (UUID, FK → Lesson) - текущий урок
- `current_step_id` (UUID, FK → LessonStep) - текущий шаг
- `completed_at` (TIMESTAMP, NULL) - дата завершения курса
- `started_at` (TIMESTAMP) - дата начала курса
- `updated_at` (TIMESTAMP) - дата последнего обновления

**Связи:**
- Многие к одному с `User`
- Многие к одному с `Course`
- Многие к одному с `Lesson` (current_lesson_id)
- Многие к одному с `LessonStep` (current_step_id)

#### ChatSession (Сессия чата)
**Описание:** Сессия диалога с LLM в рамках шага `chat`

**Поля:**
- `session_id` (UUID, PK) - уникальный идентификатор сессии
- `user_id` (UUID, FK → User) - пользователь
- `step_id` (UUID, FK → LessonStep) - шаг урока типа `chat`
- `status` (VARCHAR) - статус: `active`, `completed`, `stopped`
- `created_at` (TIMESTAMP) - дата создания
- `updated_at` (TIMESTAMP) - дата последнего обновления

**Связи:**
- Многие к одному с `User`
- Многие к одному с `LessonStep`
- Один ко многим с `ChatMessage`

#### ChatMessage (Сообщение чата)
**Описание:** Отдельное сообщение в сессии чата

**Поля:**
- `message_id` (UUID, PK) - уникальный идентификатор сообщения
- `session_id` (UUID, FK → ChatSession) - сессия чата
- `role` (VARCHAR) - роль: `user` или `assistant`
- `content` (TEXT) - текст сообщения
- `created_at` (TIMESTAMP) - время отправки
- `status` (VARCHAR) - статус: `pending`, `sent`, `error`

**Связи:**
- Многие к одному с `ChatSession`

#### QuizAttempt (Попытка квиза)
**Описание:** Результат прохождения квиза пользователем

**Поля:**
- `attempt_id` (UUID, PK) - уникальный идентификатор попытки
- `user_id` (UUID, FK → User) - пользователь
- `step_id` (UUID, FK → LessonStep) - шаг урока типа `quiz_single_choice`
- `selected_option_id` (VARCHAR) - выбранный вариант ответа
- `is_correct` (BOOLEAN) - правильность ответа
- `score` (DECIMAL) - полученный балл
- `max_score` (DECIMAL) - максимальный балл
- `created_at` (TIMESTAMP) - время прохождения

**Связи:**
- Многие к одному с `User`
- Многие к одному с `LessonStep`

### 4.2 Влияние на архитектуру

**Frontend (Next.js):**
- Типы TypeScript для всех сущностей
- API routes для работы с сущностями
- Компоненты для отображения различных типов шагов
- State management для прогресса и сессий чата

**Backend (FastAPI):**
- Pydantic модели для валидации данных
- SQLAlchemy модели для работы с БД
- Endpoints для CRUD операций с сущностями
- Бизнес-логика для обработки шагов и прогресса

**Database:**
- Миграции для создания и обновления схемы
- Индексы для оптимизации запросов
- Foreign keys для целостности данных
- JSONB для гибкого хранения контента шагов

---

## 5. Feature Requirements

### 5.1 Управление курсами и уроками

#### FR-1: Отображение списка курсов
**Приоритет:** Высокий

**Описание:** Пользователь должен видеть список всех доступных курсов.

**Требования:**
- Страница со списком курсов
- Отображение названия, описания, автора каждого курса
- Индикатор прогресса для начатых курсов
- Фильтрация по статусу (все, начатые, завершенные, новые)
- Поиск по названию курса

**UI компоненты:**
- Компонент `CourseList` для отображения списка
- Компонент `CourseCard` для карточки курса
- Компонент `ProgressBar` для индикатора прогресса

**API endpoints:**
- `GET /api/courses` - список курсов
- `GET /api/courses/{course_id}/progress` - прогресс по курсу

#### FR-2: Отображение структуры урока
**Приоритет:** Высокий

**Описание:** Пользователь должен видеть структуру урока со всеми шагами.

**Требования:**
- Отображение списка шагов урока
- Индикация пройденных шагов
- Индикация текущего шага
- Возможность перехода к любому шагу (если разрешено)

**UI компоненты:**
- Компонент `LessonView` для отображения урока
- Компонент `StepList` для списка шагов
- Компонент `StepItem` для отдельного шага

**API endpoints:**
- `GET /api/lessons/{lesson_id}` - информация об уроке
- `GET /api/lessons/{lesson_id}/steps` - список шагов урока

### 5.2 Отображение шагов урока

#### FR-3: Шаг типа `message`
**Приоритет:** Высокий

**Описание:** Отображение текстового сообщения с опциональными медиа.

**Требования:**
- Отображение текста с поддержкой Markdown/HTML
- Отображение изображений из массива `media`
- Кнопка "Далее" для перехода к следующему шагу
- Автоматический переход, если кнопка не требуется

**UI компоненты:**
- Компонент `MessageStep` для отображения сообщения
- Компонент `MediaGallery` для изображений
- Компонент `Button` для кнопки продолжения

#### FR-4: Шаг типа `video`
**Приоритет:** Высокий

**Описание:** Воспроизведение видео с возможностью управления.

**Требования:**
- Встроенный видеоплеер (HTML5 video или YouTube/Vimeo embed)
- Контролы воспроизведения (play, pause, volume, fullscreen)
- Отображение названия и описания видео
- Автоматический переход к следующему шагу после завершения (опционально)
- Отслеживание прогресса просмотра

**UI компоненты:**
- Компонент `VideoStep` для отображения видео
- Компонент `VideoPlayer` для видеоплеера
- Интеграция с YouTube/Vimeo API при необходимости

#### FR-5: Шаг типа `pdf`
**Приоритет:** Высокий

**Описание:** Просмотр PDF документа во встроенном просмотрщике.

**Требования:**
- Встроенный PDF просмотрщик (например, react-pdf или PDF.js)
- Навигация по страницам
- Масштабирование (zoom in/out)
- Загрузка PDF по URL
- Кнопка "Далее" для перехода к следующему шагу

**UI компоненты:**
- Компонент `PdfStep` для отображения PDF
- Компонент `PdfViewer` для просмотрщика PDF
- Компонент `PdfControls` для управления просмотром

#### FR-6: Шаг типа `quiz_single_choice`
**Приоритет:** Высокий

**Описание:** Отображение квиза с одним правильным ответом.

**Требования:**
- Отображение вопроса
- Отображение вариантов ответов как кликабельные кнопки/радио-кнопки
- Валидация ответа на клиенте и сервере
- Отображение обратной связи после выбора ответа
- Сохранение результата в базу данных
- Автоматический переход к следующему шагу после ответа

**UI компоненты:**
- Компонент `QuizStep` для отображения квиза
- Компонент `QuizQuestion` для вопроса
- Компонент `QuizOptions` для вариантов ответов
- Компонент `QuizFeedback` для обратной связи

**API endpoints:**
- `POST /api/steps/{step_id}/quiz/attempt` - отправка ответа на квиз
- `GET /api/steps/{step_id}/quiz/attempt` - получение предыдущей попытки (если есть)

#### FR-7: Шаг типа `chat`
**Приоритет:** Критический

**Описание:** Интерфейс чата с LLM-ассистентом.

**Требования:**
- Отображение истории сообщений (пользователь и ассистент)
- Поле ввода для сообщений пользователя
- Индикатор "печатает..." во время генерации ответа
- Отправка сообщений через API
- Получение ответов от LLM через backend
- Сохранение истории чата в базу данных
- Возможность завершения чата (кнопка "Завершить диалог")
- Автоматическое завершение по условию (например, после N сообщений)

**UI компоненты:**
- Компонент `ChatStep` для отображения чата
- Компонент `ChatMessages` для списка сообщений
- Компонент `ChatMessage` для отдельного сообщения
- Компонент `ChatInput` для поля ввода
- Компонент `TypingIndicator` для индикатора печати

**API endpoints:**
- `POST /api/steps/{step_id}/chat/session` - создание сессии чата
- `GET /api/steps/{step_id}/chat/session` - получение существующей сессии
- `POST /api/chat/sessions/{session_id}/messages` - отправка сообщения
- `GET /api/chat/sessions/{session_id}/messages` - получение истории сообщений
- `POST /api/chat/sessions/{session_id}/complete` - завершение сессии

**Backend логика:**
- Интеграция с OpenAI API для генерации ответов
- Обработка системного промпта из конфигурации шага
- Управление контекстом диалога
- Обработка ошибок и retry логика

### 5.3 Управление прогрессом

#### FR-8: Отслеживание прогресса по курсу
**Приоритет:** Критический

**Описание:** Система должна отслеживать прогресс пользователя по курсу.

**Требования:**
- Сохранение текущего урока и шага при каждом взаимодействии
- Обновление прогресса при переходе к следующему шагу
- Вычисление процента завершения курса
- Отображение прогресса в UI (прогресс-бар, процент)
- Возобновление курса с последнего шага при повторном входе

**UI компоненты:**
- Компонент `ProgressBar` для визуализации прогресса
- Компонент `ProgressIndicator` для отображения процента

**API endpoints:**
- `GET /api/courses/{course_id}/progress` - получение прогресса
- `POST /api/courses/{course_id}/progress` - обновление прогресса
- `GET /api/users/{user_id}/progress` - прогресс по всем курсам

**Backend логика:**
- Автоматическое обновление прогресса при завершении шага
- Вычисление процента завершения на основе пройденных шагов
- Проверка завершения курса (все шаги пройдены)

#### FR-9: Сохранение состояния сессии
**Приоритет:** Высокий

**Описание:** Сохранение состояния пользователя для возможности возобновления.

**Требования:**
- Сохранение текущего шага в базе данных
- Сохранение истории чата для шагов типа `chat`
- Сохранение результатов квизов
- Восстановление состояния при повторном входе

**Backend логика:**
- Транзакционное сохранение состояния
- Валидация целостности данных
- Обработка конфликтов при одновременном доступе

### 5.4 Навигация

#### FR-10: Навигация по курсу
**Приоритет:** Высокий

**Описание:** Пользователь должен иметь возможность навигации по курсу.

**Требования:**
- Переход к следующему шагу после завершения текущего
- Возврат к предыдущему шагу (если разрешено)
- Переход к конкретному шагу из списка (если разрешено)
- Отображение структуры курса (уроки и шаги) в боковой панели
- Breadcrumbs для навигации

**UI компоненты:**
- Компонент `NavigationSidebar` для боковой панели
- Компонент `Breadcrumbs` для хлебных крошек
- Компонент `StepNavigation` для кнопок навигации

**Routing (Next.js):**
- `/courses` - список курсов
- `/courses/[courseId]` - страница курса со списком уроков
- `/courses/[courseId]/lessons/[lessonId]` - страница урока
- `/courses/[courseId]/lessons/[lessonId]/steps/[stepId]` - страница шага

### 5.5 Аутентификация и авторизация

#### FR-11: Аутентификация пользователей
**Приоритет:** Высокий

**Описание:** Система должна поддерживать аутентификацию пользователей.

**Требования:**
- Регистрация нового пользователя (email + password)
- Вход существующего пользователя
- Выход из системы
- Сохранение сессии (JWT токен или session cookie)
- Защита API endpoints от неавторизованного доступа

**UI компоненты:**
- Компонент `LoginForm` для входа
- Компонент `RegisterForm` для регистрации
- Компонент `UserMenu` для меню пользователя

**API endpoints:**
- `POST /api/auth/register` - регистрация
- `POST /api/auth/login` - вход
- `POST /api/auth/logout` - выход
- `GET /api/auth/me` - информация о текущем пользователе

**Backend логика:**
- Хеширование паролей (bcrypt)
- Генерация JWT токенов
- Middleware для проверки аутентификации
- Обработка истечения токенов

#### FR-12: Контроль доступа к курсам
**Приоритет:** Средний

**Описание:** Поддержка ограниченного доступа к курсам.

**Требования:**
- Проверка доступа при начале курса
- Отображение сообщения об отказе в доступе
- Управление списком пользователей с доступом (для администраторов)

**Backend логика:**
- Проверка флага `is_restricted` курса
- Проверка наличия пользователя в списке доступа
- Возврат соответствующего HTTP статуса (403 Forbidden)

---

## 6. Flows

### 6.1 User Flow: Прохождение курса

```
1. Пользователь открывает приложение
   ↓
2. Страница входа / регистрации (если не авторизован)
   ↓
3. Главная страница со списком курсов
   ↓
4. Пользователь выбирает курс
   ↓
5. Страница курса со списком уроков
   ↓
6. Пользователь выбирает урок (или продолжает с текущего)
   ↓
7. Страница урока со списком шагов
   ↓
8. Пользователь открывает шаг урока
   ↓
9. Отображение шага в зависимости от типа:
   - message: текст + медиа + кнопка "Далее"
   - video: видеоплеер
   - pdf: PDF просмотрщик
   - quiz_single_choice: вопрос + варианты ответов
   - chat: интерфейс чата
   ↓
10. Пользователь взаимодействует с шагом
    ↓
11. Система сохраняет результат и обновляет прогресс
    ↓
12. Автоматический переход к следующему шагу (или ручной)
    ↓
13. Повтор шагов 8-12 для следующих шагов
    ↓
14. После завершения урока - переход к следующему уроку
    ↓
15. После завершения курса - страница завершения
```

### 6.2 User Flow: Диалог с LLM

```
1. Пользователь достигает шага типа `chat`
   ↓
2. Система отображает начальное сообщение из конфигурации шага
   ↓
3. Система создает ChatSession в базе данных
   ↓
4. Пользователь вводит сообщение в поле ввода
   ↓
5. Пользователь нажимает "Отправить"
   ↓
6. Frontend отправляет POST /api/chat/sessions/{session_id}/messages
   ↓
7. Backend сохраняет сообщение пользователя в БД
   ↓
8. Backend формирует запрос к LLM API:
   - Системный промпт из конфигурации шага
   - История диалога из БД
   - Сообщение пользователя
   ↓
9. Backend отправляет запрос в OpenAI API
   ↓
10. Backend получает ответ от LLM
    ↓
11. Backend сохраняет ответ ассистента в БД
    ↓
12. Backend возвращает ответ frontend
    ↓
13. Frontend отображает ответ в чате
    ↓
14. Повтор шагов 4-13 для следующих сообщений
    ↓
15. Завершение диалога:
    - По действию пользователя (кнопка "Завершить")
    - По условию (например, после N сообщений)
    - По ответу LLM с маркером завершения
    ↓
16. Система помечает ChatSession как completed
    ↓
17. Переход к следующему шагу урока
```

### 6.3 Data Flow: Обновление прогресса

```
1. Пользователь завершает шаг урока
   ↓
2. Frontend отправляет POST /api/courses/{course_id}/progress
   Body: {
     current_lesson_id: "...",
     current_step_id: "..."
   }
   ↓
3. Backend валидирует данные через Pydantic модель
   ↓
4. Backend проверяет аутентификацию пользователя
   ↓
5. Backend получает или создает CourseProgress запись
   ↓
6. Backend обновляет поля:
   - current_lesson_id
   - current_step_id
   - updated_at
   ↓
7. Backend вычисляет процент завершения:
   - Подсчет пройденных шагов
   - Подсчет общего количества шагов
   - Вычисление процента
   ↓
8. Backend проверяет завершение курса:
   - Если все шаги пройдены → устанавливает completed_at
   ↓
9. Backend сохраняет изменения в БД (транзакция)
   ↓
10. Backend возвращает обновленный прогресс frontend
    ↓
11. Frontend обновляет UI:
    - Прогресс-бар
    - Индикатор текущего шага
    - Статус завершения курса
```

### 6.4 Data Flow: Прохождение квиза

```
1. Пользователь открывает шаг типа `quiz_single_choice`
   ↓
2. Frontend загружает данные шага через GET /api/steps/{step_id}
   ↓
3. Frontend отображает вопрос и варианты ответов
   ↓
4. Пользователь выбирает вариант ответа
   ↓
5. Frontend отправляет POST /api/steps/{step_id}/quiz/attempt
   Body: {
     selected_option_id: "opt1"
   }
   ↓
6. Backend валидирует данные
   ↓
7. Backend получает конфигурацию шага из БД
   ↓
8. Backend проверяет правильность ответа:
   - Сравнивает selected_option_id с correct_option_id
   ↓
9. Backend создает QuizAttempt запись:
   - user_id
   - step_id
   - selected_option_id
   - is_correct
   - score (1 если правильно, 0 если нет)
   - max_score (1)
   ↓
10. Backend сохраняет QuizAttempt в БД
    ↓
11. Backend возвращает результат frontend:
    {
      is_correct: true/false,
      feedback: "Правильно!" / "Неправильно",
      score: 1/0
    }
    ↓
12. Frontend отображает обратную связь пользователю
    ↓
13. Frontend обновляет прогресс (переход к следующему шагу)
```

---

## 7. UI/UX View

### 7.1 Общая структура интерфейса

**Layout:**
- **Header:** Логотип, навигация, меню пользователя
- **Sidebar (опционально):** Структура курса, список шагов
- **Main Content:** Контент текущего шага
- **Footer:** Дополнительная информация, ссылки

**Навигация:**
- Breadcrumbs для понимания текущего местоположения
- Кнопки "Назад" / "Далее" для навигации между шагами
- Прогресс-бар вверху страницы для визуализации прогресса

### 7.2 Страницы и компоненты

#### Страница: Список курсов (`/courses`)

**Компоненты:**
- `CourseList` - список курсов в виде карточек
- `CourseCard` - карточка курса:
  - Название курса
  - Описание (краткое)
  - Автор
  - Прогресс (если курс начат)
  - Кнопка "Начать" / "Продолжить"
- `SearchBar` - поиск по курсам
- `FilterTabs` - фильтры (все, начатые, завершенные, новые)

**Поведение:**
- При клике на карточку курса → переход на страницу курса
- При клике на "Начать" → создание новой сессии и переход к первому уроку
- При клике на "Продолжить" → переход к текущему шагу

#### Страница: Курс (`/courses/[courseId]`)

**Компоненты:**
- `CourseHeader` - заголовок курса с описанием
- `LessonList` - список уроков курса
- `LessonCard` - карточка урока:
  - Название урока
  - Описание
  - Прогресс урока (сколько шагов пройдено)
  - Статус (не начат, в процессе, завершен)
- `ProgressOverview` - общий прогресс по курсу

**Поведение:**
- При клике на урок → переход на страницу урока
- Отображение текущего урока (выделение)
- Индикация завершенных уроков

#### Страница: Урок (`/courses/[courseId]/lessons/[lessonId]`)

**Компоненты:**
- `LessonHeader` - заголовок урока
- `StepList` - список шагов урока (боковая панель или вкладки)
- `StepView` - отображение текущего шага (основной контент)
- `ProgressBar` - прогресс по уроку

**Поведение:**
- При загрузке страницы → отображение текущего шага (или первого)
- При клике на шаг в списке → переход к этому шагу
- Автоматическое обновление прогресса при завершении шага

#### Компонент: MessageStep

**Структура:**
- Заголовок (опционально)
- Текст сообщения с поддержкой Markdown/HTML
- Галерея изображений (если есть `media`)
- Кнопка "Далее" (если требуется)

**Поведение:**
- Рендеринг Markdown/HTML контента
- Отображение изображений в галерее с возможностью увеличения
- При клике на "Далее" → переход к следующему шагу
- Если кнопка не требуется → автоматический переход через 2-3 секунды

#### Компонент: VideoStep

**Структура:**
- Заголовок видео
- Описание (опционально)
- Видеоплеер (встроенный или embed)
- Контролы воспроизведения

**Поведение:**
- Автоматическая загрузка видео по URL
- Поддержка различных форматов (MP4, YouTube, Vimeo)
- Отслеживание прогресса просмотра
- Автоматический переход к следующему шагу после завершения (опционально)
- Кнопка "Далее" для ручного перехода

#### Компонент: PdfStep

**Структура:**
- Заголовок документа
- PDF просмотрщик с навигацией
- Контролы (страницы, масштаб)

**Поведение:**
- Загрузка PDF по URL
- Отображение страниц PDF
- Навигация по страницам (предыдущая/следующая)
- Масштабирование (zoom in/out)
- Кнопка "Далее" для перехода к следующему шагу

#### Компонент: QuizStep

**Структура:**
- Вопрос (текст)
- Варианты ответов (радио-кнопки или кнопки)
- Кнопка "Отправить ответ"

**Поведение:**
- Отображение вопроса и вариантов ответов
- Выбор варианта ответа пользователем
- При клике на "Отправить":
  - Отправка ответа на сервер
  - Отображение индикатора загрузки
  - Получение результата (правильно/неправильно)
  - Отображение обратной связи
  - Обновление прогресса
  - Автоматический переход к следующему шагу через 2-3 секунды

**Состояния:**
- `idle` - ожидание выбора ответа
- `submitting` - отправка ответа
- `feedback` - отображение обратной связи
- `completed` - завершено, переход к следующему шагу

#### Компонент: ChatStep

**Структура:**
- Заголовок чата
- Область сообщений (scrollable)
- Поле ввода с кнопкой "Отправить"
- Кнопка "Завершить диалог"

**Поведение:**
- При загрузке → отображение начального сообщения из конфигурации
- Отображение истории сообщений (если сессия уже существует)
- Ввод сообщения пользователем
- При отправке сообщения:
  - Добавление сообщения пользователя в чат
  - Отображение индикатора "печатает..."
  - Отправка запроса на сервер
  - Получение ответа от LLM
  - Добавление ответа ассистента в чат
  - Прокрутка к последнему сообщению
- При клике на "Завершить диалог":
  - Завершение сессии чата
  - Переход к следующему шагу

**Сообщения:**
- Сообщения пользователя: выравнивание справа, стиль пользователя
- Сообщения ассистента: выравнивание слева, стиль ассистента
- Индикатор "печатает...": анимация точек, выравнивание слева

**Ограничения:**
- Максимальное количество сообщений (из конфигурации шага)
- Предупреждение при приближении к лимиту
- Автоматическое завершение при достижении лимита

### 7.3 Адаптивность

**Desktop (> 1024px):**
- Боковая панель со структурой курса
- Основной контент занимает большую часть экрана
- Полная навигация видна

**Tablet (768px - 1024px):**
- Боковая панель скрыта, открывается по клику
- Основной контент занимает весь экран
- Навигация через меню

**Mobile (< 768px):**
- Боковая панель скрыта, открывается через меню
- Полноэкранный просмотр контента
- Упрощенная навигация (только кнопки "Назад" / "Далее")
- Оптимизация для touch-взаимодействия

### 7.4 Состояния загрузки и ошибок

**Загрузка:**
- Skeleton screens при загрузке контента
- Индикаторы загрузки для асинхронных операций
- Плавные переходы между состояниями

**Ошибки:**
- Отображение сообщений об ошибках в понятном формате
- Кнопки "Повторить" для повторной попытки
- Fallback UI при критических ошибках

---

## 8. Non-Functional Requirements

### 8.1 Производительность

**Требования:**
- Время загрузки первой страницы: < 2 секунды
- Время отклика API: < 500ms для 95% запросов
- Время генерации ответа LLM: < 10 секунд для 90% запросов
- Поддержка одновременной работы 1000+ пользователей

**Метрики:**
- First Contentful Paint (FCP): < 1.5s
- Largest Contentful Paint (LCP): < 2.5s
- Time to Interactive (TTI): < 3.5s
- Cumulative Layout Shift (CLS): < 0.1

**Оптимизации:**
- Server-side rendering для начальной загрузки
- Code splitting для уменьшения bundle size
- Кэширование статических ресурсов
- Lazy loading для изображений и видео
- Оптимизация запросов к базе данных

### 8.2 Надежность

**Требования:**
- Доступность системы: 99% uptime
- Обработка ошибок подключения к БД
- Retry логика для внешних API (OpenAI)
- Graceful degradation при недоступности внешних сервисов
- Автоматическое сохранение прогресса пользователя

**Обработка ошибок:**
- Логирование всех ошибок
- Уведомления пользователя о временных проблемах
- Автоматическое восстановление при сбоях
- Резервное копирование базы данных

### 8.3 Безопасность

**Требования:**
- Валидация всех входных данных
- Защита от SQL инъекций (использование ORM)
- Защита от XSS (санитизация пользовательского ввода)
- Защита от CSRF (CSRF токены)
- Хеширование паролей (bcrypt)
- Безопасное хранение API ключей (переменные окружения)
- HTTPS для всех соединений

**Аутентификация:**
- JWT токены с истечением срока действия
- Refresh tokens для обновления сессий
- Защита API endpoints от неавторизованного доступа

### 8.4 Масштабируемость

**Требования:**
- Поддержка горизонтального масштабирования
- Возможность запуска нескольких инстансов backend
- Использование connection pooling для БД
- Оптимизация запросов к БД (индексы)
- Кэширование часто используемых данных (Redis, опционально)

**Архитектура:**
- Stateless backend для возможности масштабирования
- Использование внешнего хранилища для сессий (если необходимо)
- Микросервисная архитектура (будущее)

### 8.5 Удобство использования

**Требования:**
- Интуитивный интерфейс
- Понятные сообщения об ошибках
- Подсказки и инструкции для пользователей
- Адаптивный дизайн для различных устройств
- Поддержка клавиатурной навигации
- Accessibility (WCAG 2.1 Level AA)

**UX принципы:**
- Минималистичный дизайн
- Четкая визуальная иерархия
- Консистентность интерфейса
- Быстрая обратная связь на действия пользователя

### 8.6 Совместимость

**Требования:**
- Поддержка современных браузеров (Chrome, Firefox, Safari, Edge)
- Поддержка мобильных браузеров (iOS Safari, Chrome Mobile)
- Graceful degradation для старых браузеров

**Технические требования:**
- ES6+ для JavaScript
- CSS Grid и Flexbox для layout
- Fetch API для HTTP запросов
- WebSocket для real-time обновлений (опционально)

---

## 9. Out of Scope

### 9.1 Что НЕ входит в текущую версию

**Функциональность:**
- Создание и редактирование курсов через веб-интерфейс (только просмотр и прохождение)
- Групповые курсы и совместное обучение
- Система достижений и бейджей
- Уведомления о новых курсах
- Социальные функции (комментарии, обсуждения)
- Платежи и монетизация
- Экспорт сертификатов
- Офлайн режим

**Технические аспекты:**
- Мобильные приложения (iOS/Android)
- PWA (Progressive Web App) функциональность
- Real-time синхронизация между устройствами
- Интеграция с внешними LMS системами
- Webhook для внешних систем
- Расширенная аналитика и дашборды

**Контент:**
- Генерация контента через ИИ
- Адаптивное обучение на основе прогресса
- Персонализация контента через ИИ

**Административные функции:**
- Управление пользователями через веб-интерфейс
- Управление доступом к курсам через веб-интерфейс
- Расширенная аналитика для администраторов

**Примечание:** Эти функции могут быть добавлены в будущих версиях, но не являются частью текущего PRD.

---

## 10. Open Questions

### 10.1 Требующие уточнения вопросы

**Аутентификация:**
- Какой метод аутентификации использовать? (Email/password, OAuth, SSO)
- Нужна ли поддержка социальных сетей для входа?
- Как обрабатывать анонимных пользователей?

**Прогресс и навигация:**
- Можно ли пользователю возвращаться к предыдущим шагам?
- Можно ли пропускать шаги?
- Нужна ли возможность повторного прохождения курса?

**Чат с LLM:**
- Какие модели LLM поддерживать? (только OpenAI или другие провайдеры)
- Нужна ли поддержка голосовых сообщений в веб-версии?
- Как обрабатывать длинные диалоги (контекстное окно)?
- Нужна ли возможность экспорта истории чата?

**Мультимедиа:**
- Где хранить видео и PDF файлы? (CDN, облачное хранилище)
- Нужна ли поддержка других форматов медиа? (аудио, интерактивные элементы)
- Как обрабатывать большие файлы?

**Производительность:**
- Нужен ли кэш для часто запрашиваемых данных?
- Как обрабатывать пиковые нагрузки?
- Нужна ли система очередей для обработки запросов к LLM?

**Интеграции:**
- Нужна ли интеграция с существующей Telegram версией?
- Как синхронизировать данные между Telegram и Web версиями?
- Нужен ли единый аккаунт для обеих версий?

**Дизайн:**
- Есть ли существующий дизайн-система или брендбук?
- Какие цвета и стили использовать?
- Нужна ли темная тема?

**Развертывание:**
- Где будет развернуто приложение? (облако, собственный сервер)
- Какие требования к инфраструктуре?
- Нужна ли поддержка Docker Compose для локальной разработки?

---

## 11. Технические детали

### 11.1 Архитектура приложения

**Frontend (Next.js 14 + TypeScript):**
- **Framework:** Next.js 14 с App Router
- **Language:** TypeScript
- **Styling:** CSS Modules или Tailwind CSS
- **State Management:** React Context API или Zustand
- **HTTP Client:** Fetch API или axios
- **Form Handling:** React Hook Form
- **PDF Viewer:** react-pdf или PDF.js
- **Video Player:** HTML5 video или react-player

**Backend (Python + FastAPI):**
- **Framework:** FastAPI
- **Language:** Python 3.12+
- **ORM:** SQLAlchemy
- **Validation:** Pydantic
- **Database:** PostgreSQL
- **LLM Integration:** OpenAI API (openai library)
- **Authentication:** JWT (python-jose, passlib)

**Database (PostgreSQL):**
- **Version:** PostgreSQL 14+
- **Migrations:** Alembic
- **Connection Pooling:** SQLAlchemy connection pool

### 11.2 API Endpoints

**Аутентификация:**
- `POST /api/auth/register` - регистрация
- `POST /api/auth/login` - вход
- `POST /api/auth/logout` - выход
- `GET /api/auth/me` - текущий пользователь

**Курсы:**
- `GET /api/courses` - список курсов
- `GET /api/courses/{course_id}` - информация о курсе
- `GET /api/courses/{course_id}/progress` - прогресс по курсу
- `POST /api/courses/{course_id}/start` - начать курс

**Уроки:**
- `GET /api/courses/{course_id}/lessons` - список уроков курса
- `GET /api/lessons/{lesson_id}` - информация об уроке
- `GET /api/lessons/{lesson_id}/steps` - список шагов урока

**Шаги:**
- `GET /api/steps/{step_id}` - информация о шаге
- `POST /api/steps/{step_id}/complete` - завершить шаг

**Квизы:**
- `POST /api/steps/{step_id}/quiz/attempt` - отправить ответ на квиз
- `GET /api/steps/{step_id}/quiz/attempt` - получить предыдущую попытку

**Чат:**
- `POST /api/steps/{step_id}/chat/session` - создать сессию чата
- `GET /api/steps/{step_id}/chat/session` - получить сессию чата
- `POST /api/chat/sessions/{session_id}/messages` - отправить сообщение
- `GET /api/chat/sessions/{session_id}/messages` - получить историю сообщений
- `POST /api/chat/sessions/{session_id}/complete` - завершить сессию

### 11.3 Database Schema

**Основные таблицы:**
- `users` - пользователи
- `courses` - курсы
- `lessons` - уроки
- `lesson_steps` - шаги уроков
- `course_progress` - прогресс по курсам
- `chat_sessions` - сессии чата
- `chat_messages` - сообщения чата
- `quiz_attempts` - попытки квизов

**Индексы:**
- `users.email` (UNIQUE)
- `courses.course_id` (PRIMARY KEY)
- `lessons.course_id` (INDEX)
- `lesson_steps.lesson_id` (INDEX)
- `course_progress.user_id, course_id` (INDEX)
- `chat_sessions.step_id` (INDEX)
- `chat_messages.session_id` (INDEX)
- `quiz_attempts.user_id, step_id` (INDEX)

### 11.4 Конфигурация

**Environment Variables:**
- `DATABASE_URL` - строка подключения к PostgreSQL
- `SECRET_KEY` - секретный ключ для JWT
- `OPENAI_API_KEY` - API ключ OpenAI
- `FRONTEND_URL` - URL frontend приложения (для CORS)
- `ENVIRONMENT` - окружение (development, production)

**Docker Compose:**
- Сервис `frontend` (Next.js)
- Сервис `backend` (FastAPI)
- Сервис `db` (PostgreSQL)

---

## 12. Связанные документы

### 12.1 Референсные документы

- `docs/PRD.md` - Telegram версия PRD (базовый документ)
- `docs/database.md` - документация по базе данных
- `docs/elements.md` - документация по типам элементов

### 12.2 Архитектурные решения

- Next.js 14 App Router документация
- FastAPI документация
- PostgreSQL документация
- OpenAI API документация

---

**Конец документа**

