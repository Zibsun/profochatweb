# Структура документации ProfoChat Web (для AI агентов)

Документ описывает структуру технической документации для AI агентов, работающих с кодом проекта ProfoChat Web.

**Дата создания:** 2024  
**Статус:** Предложение  
**Целевая аудитория:** AI агенты (LLM-based code assistants)

---

## Принципы организации документации

### 1. Техническая фокусировка
- Документация описывает структуру кода, архитектуру и внутренние процессы
- Минимум пользовательских руководств, максимум технических спецификаций
- Фокус на том, как система работает технически, а не как её использовать

### 2. Структурированность для семантического поиска
- Четкая иерархия разделов для эффективного поиска
- Детальные описания компонентов с примерами кода
- Связи между компонентами явно документированы

### 3. Контекст для принятия решений
- Архитектурные решения и их обоснование
- Текущие проблемы и планы рефакторинга
- Конвенции кода и паттерны проекта

---

## Структура документации для AI агентов

```
docs/
├── README.md                          # Главная страница документации (навигация)
│
├── architecture/                      # Архитектура системы
│   ├── README.md                      # Обзор архитектуры
│   ├── overview.md                    # Общая архитектура (текущий architecture.md)
│   ├── core-logic.md                  # Core Logic модули (course.py, elements/, db.py, chat.py)
│   ├── webapp-architecture.md         # Архитектура веб-приложения (frontend + backend)
│   ├── database-architecture.md       # Архитектура БД и SaaS модель
│   ├── api-design.md                  # Дизайн API, версионирование, паттерны
│   └── integrations.md                # Внешние интеграции (OpenAI, Eleven Labs)
│
├── reference/                         # Справочная документация
│   ├── README.md                      # Обзор справочников
│   ├── api/                           # API Reference
│   │   ├── README.md
│   │   ├── authentication.md          # API аутентификации (endpoints, схемы)
│   │   ├── courses.md                 # API курсов (endpoints, модели данных)
│   │   ├── lessons.md                 # API уроков
│   │   ├── chat.md                    # API чата и диалогов
│   │   └── quiz.md                    # API квизов
│   ├── elements/                      # Справочник элементов (техническая спецификация)
│   │   ├── README.md
│   │   ├── element-base.md            # Базовый класс Element
│   │   ├── message.md                 # Элемент Message (класс, методы, параметры)
│   │   ├── dialog.md                  # Элемент Dialog (интеграция с LLM)
│   │   ├── quiz.md                    # Элемент Quiz (логика проверки)
│   │   ├── input.md                   # Элемент Input
│   │   └── ...                        # Остальные элементы
│   ├── database/                      # Справочник БД
│   │   ├── README.md
│   │   ├── schema.md                  # Схема БД (таблицы, связи, индексы)
│   │   ├── migrations.md              # Система миграций (текущий database_migrations.md)
│   │   ├── queries.md                  # Типовые SQL запросы и паттерны
│   │   └── models.md                   # SQLAlchemy модели (структура, связи)
│   ├── configuration/                 # Конфигурация
│   │   ├── README.md
│   │   ├── config-yaml.md             # Структура config.yaml
│   │   └── environment-variables.md   # Переменные окружения (описание, значения)
│   └── code-conventions/              # Конвенции кода
│       ├── README.md
│       ├── python-style.md            # Стиль Python кода, паттерны
│       ├── typescript-style.md        # Стиль TypeScript кода
│       └── naming-conventions.md      # Соглашения по именованию
│
├── how-it-works/                      # Как это работает (технические детали)
│   ├── README.md
│   ├── course-execution.md            # Выполнение курса (навигация, состояние)
│   ├── element-processing.md          # Обработка элементов (регистр, lifecycle)
│   ├── chat-integration.md            # Интеграция с ИИ (OpenAI API, обработка ответов)
│   ├── progress-tracking.md           # Отслеживание прогресса (таблицы, логика)
│   ├── data-flow.md                   # Потоки данных (frontend ↔ backend ↔ DB)
│   ├── pages/                         # Как работают страницы (технически)
│   │   ├── courses-page.md            # Страница курсов (компоненты, API calls)
│   │   ├── course-editor.md           # Редактор курсов (состояние, операции)
│   │   ├── bots-page.md               # Страница ботов (управление ботами)
│   │   └── groups-page.md             # Страница групп (группы, приглашения)
│   └── workflows/                     # Технические процессы
│       ├── course-loading.md          # Загрузка курса (YAML vs DB)
│       ├── element-rendering.md       # Рендеринг элементов (frontend)
│       └── session-management.md      # Управление сессиями
│
└── reqs/                              # Требования и планы (контекст развития)
    ├── README.md                      # Обзор требований
    ├── PRD.md                         # Product Requirements Document (контекст продукта)
    ├── architecture-issues.md         # Архитектурные проблемы (что не так)
    ├── architecture-refactoring.md     # План рефакторинга (куда двигаться)
    ├── transition-to-saas.md          # Переход к SaaS (контекст изменений)
    └── ...                            # Остальные документы требований
```

---

## Детальное описание разделов

### 1. `architecture/` — Архитектура системы

**Назначение для AI агентов:** Понимание структуры кода, архитектурных решений и связей между компонентами

**Содержание:**
- **overview.md** — общая архитектура системы (объединяет текущий architecture.md)
  - Компоненты системы и их взаимодействие
  - Технологический стек
  - Потоки данных
  
- **core-logic.md** — Core Logic модули (course.py, elements/, db.py, chat.py)
  - Структура модулей в корне проекта
  - Как Core Logic используется в веб-приложении
  - Зависимости и связи между модулями
  
- **webapp-architecture.md** — архитектура веб-приложения
  - Структура frontend (Next.js, компоненты, routing)
  - Структура backend (FastAPI, роутеры, сервисы, модели)
  - Интеграция frontend ↔ backend
  
- **database-architecture.md** — архитектура БД
  - SaaS модель и мультитенантность
  - Схема базы данных
  - Два подхода к работе с БД (прямые SQL vs SQLAlchemy ORM)
  
- **api-design.md** — дизайн API
  - Структура API endpoints
  - Версионирование (/api/v1/, /api/mvp/)
  - Паттерны запросов/ответов
  - Обработка ошибок
  
- **integrations.md** — внешние интеграции
  - OpenAI API (модели, параметры, обработка)
  - Eleven Labs API (TTS, STT)
  - Конфигурация и управление ключами

**Цель:** Дать AI агенту понимание архитектуры для правильного понимания кода и принятия решений

---

### 2. `reference/` — Справочная документация

**Назначение для AI агентов:** Технические спецификации для работы с кодом

#### 2.1 `api/` — API Reference
- **authentication.md** — API аутентификации
  - Endpoints, схемы запросов/ответов
  - Механизм аутентификации (JWT, сессии)
  - Middleware и защита роутов
  
- **courses.md** — API курсов
  - Endpoints для работы с курсами
  - Модели данных (Pydantic schemas)
  - Бизнес-логика в сервисах
  
- **chat.md** — API чата и диалогов
  - Создание сессий чата
  - Отправка сообщений в LLM
  - Управление историей диалога
  
- **quiz.md** — API квизов
  - Отправка ответов
  - Проверка правильности
  - Сохранение результатов

#### 2.2 `elements/` — Справочник элементов (техническая спецификация)
- **element-base.md** — базовый класс Element
  - Структура класса, методы
  - Жизненный цикл элемента
  - Регистр элементов (element_registry)
  
- **message.md** — элемент Message
  - Класс Message, методы обработки
  - Параметры элемента (YAML → Python)
  - Рендеринг на frontend
  
- **dialog.md** — элемент Dialog
  - Интеграция с LLM сервисом
  - Обработка системных промптов
  - Управление контекстом диалога
  
- **quiz.md** — элемент Quiz
  - Логика проверки ответов
  - Подсчет баллов
  - Обработка результатов
  
- И другие элементы (input, multichoice, jump, delay, end, test, revision)

#### 2.3 `database/` — Справочник БД
- **schema.md** — схема БД
  - Все таблицы с полями и типами
  - Связи между таблицами (foreign keys)
  - Индексы и ограничения
  
- **migrations.md** — система миграций
  - Структура миграций (Alembic)
  - Как создавать миграции
  - Откат миграций
  
- **queries.md** — типовые SQL запросы
  - Паттерны запросов из db.py
  - Оптимизация запросов
  - Транзакции
  
- **models.md** — SQLAlchemy модели
  - Структура моделей в backend/app/models/
  - Связи между моделями
  - Использование в сервисах

#### 2.4 `configuration/` — Конфигурация
- **config-yaml.md** — структура config.yaml
  - Все секции конфигурации
  - Значения по умолчанию
  - Использование в коде
  
- **environment-variables.md** — переменные окружения
  - Список всех переменных
  - Обязательные vs опциональные
  - Значения для разных окружений

#### 2.5 `code-conventions/` — Конвенции кода
- **python-style.md** — стиль Python кода
  - PEP 8 соответствие
  - Паттерны проекта
  - Структура модулей
  
- **typescript-style.md** — стиль TypeScript кода
  - Конвенции именования
  - Структура компонентов
  - Типы и интерфейсы
  
- **naming-conventions.md** — соглашения по именованию
  - Имена файлов, классов, функций
  - Константы и переменные
  - API endpoints

**Цель:** Дать AI агенту точные технические спецификации для работы с кодом

---

### 3. `how-it-works/` — Как это работает (технические детали)

**Назначение для AI агентов:** Понимание внутренних процессов и потоков данных

**Содержание:**
- **course-execution.md** — выполнение курса
  - Как загружается курс (YAML vs DB)
  - Навигация по элементам
  - Управление состоянием (current_element)
  - Переходы между элементами
  
- **element-processing.md** — обработка элементов
  - Регистр элементов (element_registry)
  - Создание экземпляров элементов
  - Методы обработки (process, validate)
  - Сохранение результатов в БД
  
- **chat-integration.md** — интеграция с ИИ
  - Вызов OpenAI API (chat.py)
  - Обработка ответов от LLM
  - Управление контекстом диалога
  - Обработка ошибок API
  
- **progress-tracking.md** — отслеживание прогресса
  - Таблицы для хранения прогресса (conversation, run)
  - Логика расчета прогресса
  - Сохранение результатов тестов
  
- **data-flow.md** — потоки данных
  - Frontend → Backend → DB
  - Обработка запросов в API
  - Возврат данных клиенту
  - WebSocket для real-time обновлений (если есть)
  
- **pages/** — техническое описание страниц
  - **courses-page.md** — страница курсов
    - Компоненты React
    - API вызовы
    - Управление состоянием (Zustand)
    
  - **course-editor.md** — редактор курсов
    - Структура редактора
    - Операции с элементами (CRUD)
    - Сохранение изменений
    
  - **bots-page.md** — страница ботов
    - Управление ботами
    - Связь ботов с курсами
    
  - **groups-page.md** — страница групп
    - Управление группами
    - Приглашения и доступ
  
- **workflows/** — технические процессы
  - **course-loading.md** — загрузка курса
    - YAML парсинг
    - Загрузка из БД
    - Валидация структуры
    
  - **element-rendering.md** — рендеринг элементов
    - Маппинг типов элементов на React компоненты
    - Обработка пользовательского ввода
    - Обновление UI
    
  - **session-management.md** — управление сессиями
    - Создание сессий чата
    - Хранение истории
    - Таймауты и очистка

**Цель:** Дать AI агенту понимание внутренних процессов для правильной работы с кодом

---

### 4. `reqs/` — Требования и планы

**Назначение для AI агентов:** Контекст развития проекта, известные проблемы, планы изменений

**Содержание:**
- **PRD.md** — Product Requirements Document
  - Контекст продукта и цели
  - Функциональные требования
  
- **architecture-issues.md** — архитектурные проблемы
  - Известные проблемы архитектуры
  - Что нужно исправить
  - Ограничения текущей реализации
  
- **architecture-refactoring.md** — план рефакторинга
  - Предлагаемые изменения
  - Миграционный путь
  - Приоритеты
  
- **transition-to-saas.md** — переход к SaaS
  - Контекст изменений
  - Новая архитектура
  - План миграции

**Цель:** Дать AI агенту контекст для понимания направления развития и избежания повторения известных проблем

---

## Главный файл документации (`docs/README.md`)

Предлагается создать главный файл `docs/README.md` с навигацией по технической документации:

```markdown
# Техническая документация ProfoChat Web

Техническая документация для AI агентов и разработчиков, работающих с кодом проекта.

## Архитектура

- [Обзор архитектуры](architecture/README.md) — общая архитектура системы
- [Core Logic](architecture/core-logic.md) — модули в корне проекта
- [Веб-приложение](architecture/webapp-architecture.md) — frontend и backend
- [База данных](architecture/database-architecture.md) — архитектура БД и SaaS модель
- [API дизайн](architecture/api-design.md) — структура API
- [Интеграции](architecture/integrations.md) — внешние сервисы

## Справочная документация

- [API Reference](reference/api/README.md) — все API endpoints
- [Элементы курсов](reference/elements/README.md) — техническая спецификация элементов
- [База данных](reference/database/README.md) — схема, миграции, запросы
- [Конфигурация](reference/configuration/README.md) — config.yaml и переменные окружения
- [Конвенции кода](reference/code-conventions/README.md) — стиль и паттерны

## Как это работает

- [Выполнение курса](how-it-works/course-execution.md) — навигация и состояние
- [Обработка элементов](how-it-works/element-processing.md) — регистр и lifecycle
- [Интеграция с ИИ](how-it-works/chat-integration.md) — OpenAI API
- [Отслеживание прогресса](how-it-works/progress-tracking.md) — логика прогресса
- [Потоки данных](how-it-works/data-flow.md) — frontend ↔ backend ↔ DB
- [Страницы](how-it-works/pages/README.md) — техническое описание страниц
- [Процессы](how-it-works/workflows/README.md) — технические процессы

## Требования и планы

- [Обзор требований](reqs/README.md) — контекст развития проекта
- [Архитектурные проблемы](reqs/architecture-issues.md) — известные проблемы
- [План рефакторинга](reqs/architecture-refactoring.md) — направление изменений
- [Переход к SaaS](reqs/transition-to-saas.md) — контекст миграции
```

---

## Миграция существующей документации

### Фаза 1: Реорганизация структуры

1. **Создать новую структуру папок**
   ```bash
   mkdir -p docs/{architecture,reference/{api,elements,database,configuration,code-conventions},how-it-works/{pages,workflows}}
   ```

2. **Переместить существующие файлы:**
   - `architecture.md` → `architecture/overview.md`
   - `database.md` → `reference/database/schema.md`
   - `database_migrations.md` → `reference/database/migrations.md`
   - `elements.md` → разбить на `reference/elements/*.md`
   - `*_page_how_it_works.md` → `how-it-works/pages/*.md`
   - `course_editor_how_it_works.md` → `how-it-works/pages/course-editor.md`
   - `VISION.md` → оставить в корне `docs/`

3. **Создать README.md файлы** для каждого раздела с навигацией

### Фаза 2: Дополнение документации

1. **Создать недостающие документы:**
   - `reference/api/*.md` — детальное описание всех API endpoints
   - `reference/elements/element-base.md` — базовый класс Element
   - `reference/code-conventions/*.md` — конвенции кода
   - `how-it-works/data-flow.md` — потоки данных
   - `how-it-works/workflows/*.md` — технические процессы

2. **Обновить существующие документы:**
   - Добавить технические детали (классы, методы, структуры данных)
   - Добавить примеры кода из проекта
   - Добавить диаграммы архитектуры где необходимо
   - Улучшить структуру для семантического поиска

### Фаза 3: Интеграция и проверка

1. **Создать главный `docs/README.md`** с навигацией
2. **Проверить все ссылки** между документами
3. **Добавить индексы** для быстрого поиска компонентов
4. **Добавить метаданные** для улучшения семантического поиска

---

## Рекомендации по написанию документации для AI агентов

### Структура документа

Каждый документ должен иметь:

1. **Заголовок** с четким описанием темы
2. **Содержание** (для документов > 200 строк) — для навигации
3. **Введение** — что описывает документ и его назначение
4. **Основной контент** — структурированный по разделам с подзаголовками
5. **Примеры кода** — реальные примеры из проекта с путями к файлам
6. **Связанные документы** — ссылки на связанную документацию
7. **Метаданные** — ключевые слова для семантического поиска

### Стиль написания для AI агентов

- **Техническая точность** — точные названия классов, методов, переменных
- **Примеры кода** — всегда включайте примеры с путями к файлам
- **Структура данных** — описывайте структуры данных (классы, типы, схемы)
- **Потоки данных** — явно описывайте потоки данных между компонентами
- **Зависимости** — документируйте зависимости между модулями
- **Контекст** — объясняйте "почему", а не только "что"

### Форматирование

- Используйте Markdown для всех документов
- Добавляйте диаграммы через Mermaid для архитектуры
- Используйте блоки кода с указанием языка и путей к файлам:
  ```python
  # file: course.py
  class Course:
      def get_current_element(self, chat_id):
          ...
  ```
- Добавляйте метаданные в комментариях для улучшения поиска:
  ```markdown
  <!-- Keywords: course execution, element navigation, current_element -->
  ```

### Структура для семантического поиска

Каждый документ должен содержать:

1. **Ключевые понятия** — основные термины и концепции
2. **Связи** — явные ссылки на связанные компоненты
3. **Контекст использования** — где и как используется описываемый компонент
4. **Известные ограничения** — что не работает или работает не так

---

## Автоматизация для AI агентов

### Предлагается добавить:

1. **Индексы компонентов** — автоматическая генерация индексов классов, функций, endpoints
2. **Граф зависимостей** — визуализация зависимостей между модулями
3. **Проверка актуальности** — сравнение документации с кодом
4. **Семантические метки** — автоматическое добавление меток для улучшения поиска

### Формат метаданных

В начале каждого документа добавлять метаданные:

```markdown
---
title: Course Execution
type: how-it-works
components: [course.py, elements/, db.py]
keywords: [course execution, element navigation, state management]
related: [architecture/core-logic.md, reference/elements/element-base.md]
---
```

---

## Метрики успеха для AI агентов

Документация считается успешной, если:

1. ✅ AI агент может найти нужный компонент по семантическому запросу
2. ✅ Все классы и функции имеют документацию с примерами
3. ✅ Все API endpoints задокументированы со схемами запросов/ответов
4. ✅ Потоки данных между компонентами явно описаны
5. ✅ Архитектурные решения и их обоснование задокументированы
6. ✅ Известные проблемы и ограничения явно указаны
7. ✅ Документация синхронизирована с кодом (проверка актуальности)

---

## Следующие шаги

1. **Создать** новую структуру папок
2. **Начать миграцию** существующей документации
3. **Дополнить** недостающие технические разделы
4. **Добавить метаданные** для улучшения семантического поиска
5. **Настроить автоматизацию** проверки и генерации индексов
