# Требования: Превращение Course Editor прототипа в работающее приложение

**Версия:** 2.0  
**Дата:** 2024-12  
**Статус:** Требования  
**Приоритет:** Высокий

---

## Краткое резюме

Этот документ описывает требования для превращения прототипа Course Editor в полноценное приложение, которое:

- **Работает с YAML файлами** вместо базы данных
- Загружает курс из YAML файла по `course_id` (путь берется из `courses.yml`)
- Преобразует YAML структуру в блоки редактора для визуального редактирования
- Сохраняет изменения обратно в YAML файл по кнопке "Save draft"
- Обновляет `courses.yml` при создании новых курсов
- **Поддерживает 5 типов элементов на старте:** Section, Message, Quiz, Input, Dialog

**Ключевое отличие от версии 1.0:** Редактор работает напрямую с YAML файлами (`scripts/{bot_folder}/*.yml`), а не с базой данных. Это упрощает интеграцию и позволяет сохранять курсы в том же формате, в котором они хранятся в системе.

**Начальный набор типов элементов:** На первом этапе редактор поддерживает 5 типов элементов:
- **Section** - разделитель секций (`type: section` с полем `title`)
- **Message** - текстовые сообщения (`type: message`)
- **Quiz** - викторины с одним правильным ответом (`type: quiz`)
- **Input** - ввод текста пользователем (`type: input`)
- **Dialog** - диалог с ИИ (`type: dialog`)

**Примечание:** Section элементы сохраняются в YAML, но игнорируются чатботом при выполнении курса - они используются только для визуальной организации в редакторе.

Остальные типы элементов (audio, question, multi_choice, test, jump, revision, delay, end) будут добавлены в следующих итерациях.

---

## 1. Обзор

### 1.1 Текущее состояние

Прототип Course Editor (`docs/prototypes/course_editor`) представляет собой визуальный редактор курсов с следующими возможностями:

- ✅ Триколонный интерфейс (Structure | Content | Properties)
- ✅ Редактирование блоков типов: **Section, Message, Quiz, Input, Dialog** (5 типов)
- ✅ Drag & Drop для изменения порядка блоков
- ✅ Редактирование свойств блоков через панель Properties
- ✅ AI Assistant для улучшения контента (stub-реализация)
- ✅ Локальное хранение данных в состоянии React компонента
- ✅ Базовый UI без интеграции с backend

**Поддерживаемые типы элементов:**
- **Section** - разделитель секций (`type: section` с полем `title`)
- **Message** - текстовые сообщения (`type: message`)
- **Quiz** - викторины с вариантами ответов (`type: quiz`)
- **Input** - поля ввода текста (`type: input`)
- **Dialog** - диалоги с ИИ-ассистентом (`type: dialog`)

**Примечание:** Section элементы сохраняются в YAML как `{type: section, title: "..."}`, но игнорируются чатботом при выполнении курса - они используются только для визуальной организации в редакторе.

### 1.2 Целевое состояние

Редактор должен стать полноценным приложением, которое:

- Загружает существующий курс из YAML файла по `course_id`
- Преобразует YAML структуру курса в блоки редактора
- Позволяет редактировать курс визуально
- Сохраняет изменения обратно в YAML файл по кнопке "Save draft"
- Поддерживает создание новых курсов
- Работает с файловой системой (`scripts/{bot_folder}/*.yml`)
- Обновляет `courses.yml` при создании новых курсов
- Интегрируется с существующей системой аутентификации и авторизации

---

## 2. Архитектура данных

### 2.1 Текущая структура данных редактора

**Блоки редактора (Block):**
```typescript
interface Block {
  id: string;                    // Уникальный ID блока (element_id в YAML)
  type: BlockType;              // "Section" | "Message" | "Quiz" | "Input" | "Dialog"
  title?: string;               // Заголовок (для Section, Message)
  text?: string;                // Текст сообщения (для Message)
  question?: string;            // Вопрос (для Quiz)
  answers?: Answer[];           // Варианты ответов (для Quiz)
  prompt?: string;              // Промпт (для Input)
  placeholder?: string;         // Placeholder (для Input)
  normalization?: string;       // Нормализация (для Input)
  dialogTitle?: string;         // Заголовок диалога (для Dialog)
  systemPrompt?: string;        // System prompt (для Dialog)
  temperature?: number;          // Temperature (для Dialog)
  maxTokens?: number;           // Max tokens (для Dialog)
  parseMode: string;            // "TEXT" | "MARKDOWN" | "HTML"
  linkPreview: boolean;         // Показывать ли превью ссылок
  internalName?: string;        // Внутреннее имя
  tags?: string[];              // Теги
}
```

### 2.2 Структура YAML файлов курсов

**Файл `courses.yml` (список курсов):**
```yaml
course_id:
  path: scripts/course_file.yml  # Путь к файлу курса
  element: StartElement           # Опционально: начальный элемент
  restricted: yes                  # Опционально: ограниченный доступ
  decline_text: "..."             # Опционально: текст отказа
  ban_enabled: yes                # Опционально: включены блокировки
  ban_text: "..."                 # Опционально: текст блокировки
```

**YAML файл курса (`scripts/{bot_folder}/*.yml`):**
```yaml
Element_ID:
  type: message
  text: "Текст сообщения"
  button: "Текст кнопки"  # Опционально
  parse_mode: HTML        # Опционально
  link_preview: no        # Опционально
  media:                  # Опционально
    - https://example.com/image.jpg

Another_Element_ID:
  type: quiz
  text: "Вопрос"
  answers:
    - text: "Вариант 1"
      correct: yes
      feedback: "Правильно!"
    - text: "Вариант 2"
      feedback: "Неправильно"
```

**Типы элементов в YAML:**
- `section` - разделитель секций (соответствует блоку Section)
- `message` - соответствует блоку Message
- `quiz` - соответствует блоку Quiz
- `input` - соответствует блоку Input
- `dialog` - соответствует блоку Dialog
- `audio` - аудиосообщение
- `question` - опрос без правильного ответа
- `multi_choice` - множественный выбор
- `test` - итоговый тест
- `jump` - навигация
- `revision` - повторение ошибок
- `delay` - задержка
- `end` - завершение курса

### 2.3 Маппинг между блоками редактора и YAML структурой

#### Стратегия преобразования

**YAML → Блоки редактора:**
- Каждый элемент в YAML (ключ верхнего уровня) становится Block
- `id` блока = ключ элемента в YAML (Element_ID)
- `type` блока определяется из поля `type` элемента
- Поля элемента маппятся в соответствующие поля блока

**Блоки редактора → YAML:**
- Каждый Block становится элементом в YAML
- `id` блока становится ключом элемента
- Поля блока преобразуются в поля YAML элемента
- Section блоки сохраняются как `type: section` с полем `title`
- Порядок элементов в YAML определяется порядком блоков в редакторе

#### Маппинг типов блоков (начальный набор - 5 типов)

| Block Type | YAML type | Преобразование | Статус |
|------------|-----------|----------------|--------|
| Section | `section` | `{type: section, title}` | ✅ MVP |
| Message | `message` | `{type: message, text, button?, parse_mode?, link_preview?, media?}` | ✅ MVP |
| Quiz | `quiz` | `{type: quiz, text, answers: [{text, correct?, feedback?}]}` | ✅ MVP |
| Input | `input` | `{type: input, text, correct_answer, feedback_correct?, feedback_incorrect?, input_type?, parse_mode?}` | ✅ MVP |
| Dialog | `dialog` | `{type: dialog, text, system_prompt, model?, temperature?, max_messages?, parse_mode?}` | ✅ MVP |

**Будущие типы (не в MVP):**
- Audio (`audio`) - аудиосообщения
- Question (`question`) - опросы без правильного ответа
- MultiChoice (`multi_choice`) - множественный выбор
- Test (`test`) - итоговые тесты
- Jump (`jump`) - навигация
- Revision (`revision`) - повторение ошибок
- Delay (`delay`) - задержка
- End (`end`) - завершение курса

**Особенности преобразования:**

1. **Section:**
   - `title` → `title` в YAML (обязательное поле)
   - Сохраняется как `{type: section, title: "..."}`
   - Примечание: Section элементы игнорируются чатботом при выполнении курса, используются только для визуальной организации

2. **Message:**
   - `text` → `text` в YAML
   - `title` → игнорируется (или можно добавить как комментарий)
   - `parseMode` → `parse_mode` (lowercase)
   - `linkPreview` → `link_preview` (lowercase, преобразование boolean → "yes"/"no")

3. **Quiz:**
   - `question` → `text` в YAML
   - `answers` → `answers` в YAML
   - `correct: true` → `correct: yes` в YAML
   - `correct: false` → отсутствует поле `correct` или `correct: no`

4. **Input:**
   - `prompt` → `text` в YAML
   - `placeholder` → можно добавить в `text` или игнорировать
   - `normalization` → можно использовать для валидации

5. **Dialog:**
   - `dialogTitle` → можно добавить в начало `text` или игнорировать
   - `systemPrompt` → `system_prompt` в YAML
   - `temperature` → `temperature` в YAML
   - `maxTokens` → `max_messages` в YAML (или другое поле, в зависимости от формата)

---

## 3. Функциональные требования

### 3.1 Загрузка курса

#### FR-1: Загрузка существующего курса

**Описание:** Редактор должен загружать курс из YAML файла по `course_id`.

**Входные данные:**
- `course_id` (string) - идентификатор курса из URL параметра

**Процесс:**
1. При открытии `/course-editor/[course_id]` редактор делает запрос к API
2. API:
   - Читает `courses.yml` для получения пути к файлу курса
   - Загружает YAML файл курса по пути из `courses.yml`
   - Возвращает метаданные курса и содержимое YAML файла
3. Редактор преобразует YAML структуру в блоки редактора:
   - Каждый элемент YAML (ключ верхнего уровня) → Block соответствующего типа
   - Порядок определяется порядком элементов в YAML файле
   - Элементы `type: section` преобразуются в Section блоки

**API Endpoint:**
```
GET /api/course-editor/courses/{course_id}
```

**Response:**
```typescript
{
  course: {
    course_id: string;
    path: string;              // Путь к YAML файлу
    element?: string;          // Начальный элемент (если указан)
    restricted?: boolean;      // Ограниченный доступ
    decline_text?: string;     // Текст отказа
    ban_enabled?: boolean;     // Включены блокировки
    ban_text?: string;         // Текст блокировки
  };
  yaml_content: Record<string, any>;  // Содержимое YAML файла курса
  blocks: Block[];  // Преобразованные из YAML элементов
}
```

**Обработка ошибок:**
- 404: Курс не найден в `courses.yml` → показать сообщение и предложить создать новый
- 404: YAML файл не найден → показать сообщение об ошибке
- 400: Ошибка парсинга YAML → показать сообщение с деталями ошибки
- 403: Нет прав доступа → показать сообщение об ошибке
- 409: Курс хранится в БД (`path: "db"`) → показать сообщение, что курс нельзя редактировать через редактор (или предложить экспорт)
- 500: Ошибка сервера → показать сообщение и предложить повторить

#### FR-2: Создание нового курса

**Описание:** Редактор должен поддерживать создание нового курса.

**Процесс:**
1. При открытии `/course-editor/new` редактор показывает пустой редактор
2. Пользователь заполняет название курса
3. При первом сохранении:
   - Создается новый YAML файл курса в `scripts/{bot_folder}/{course_id}.yml`
   - Добавляется запись в `courses.yml` с указанием пути к файлу
   - Генерируется уникальный `course_id` (или пользователь указывает его)
4. После создания URL меняется на `/course-editor/[course_id]`

**API Endpoint:**
```
POST /api/course-editor/courses
```

**Request:**
```typescript
{
  course_id: string;           // Идентификатор курса (или генерируется автоматически)
  title: string;               // Название курса (для courses.yml)
  description?: string;        // Описание (для courses.yml)
  blocks: Block[];             // Блоки курса
  settings?: {                 // Дополнительные настройки
    element?: string;          // Начальный элемент
    restricted?: boolean;
    decline_text?: string;
    ban_enabled?: boolean;
    ban_text?: string;
  };
}
```

**Response:**
```typescript
{
  course_id: string;
  path: string;                // Путь к созданному YAML файлу
  course: {
    course_id: string;
    path: string;
    // ... другие поля из courses.yml
  };
}
```

### 3.2 Редактирование курса

#### FR-3: Редактирование метаданных курса

**Описание:** Пользователь может редактировать название и описание курса в заголовке редактора.

**Требования:**
- Изменения сохраняются локально в состоянии
- При сохранении отправляются на сервер вместе с блоками
- Валидация: название не может быть пустым

#### FR-4: Редактирование блоков

**Описание:** Все существующие функции редактирования блоков должны работать с данными из YAML.

**Требования:**
- Добавление блоков → добавление новых элементов в YAML файл
- Удаление блоков → удаление элементов из YAML файла
- Изменение порядка → изменение порядка элементов в YAML файле
- Редактирование свойств → обновление полей элементов в YAML файле
- Изменение ID блока → переименование ключа элемента в YAML (требует осторожности)

#### FR-5: Валидация перед сохранением

**Описание:** Перед сохранением необходимо валидировать данные.

**Правила валидации:**
- Название курса не может быть пустым
- Все блоки должны иметь валидные данные для своего типа:
  - Section: должен иметь `title`
  - Message: должен иметь `text`
  - Quiz: должен иметь `question` и минимум 2 варианта ответа, один из которых правильный
  - Input: должен иметь `prompt`
  - Dialog: должен иметь `systemPrompt`
- Все обязательные поля должны быть заполнены

**Обработка ошибок валидации:**
- Показать список ошибок в модальном окне или toast-уведомлениях
- Подсветить проблемные блоки в структуре
- Заблокировать сохранение до исправления ошибок

### 3.3 Сохранение курса

#### FR-6: Сохранение черновика (Save draft)

**Описание:** По кнопке "Save draft" курс сохраняется в YAML файл.

**Процесс:**
1. Пользователь нажимает кнопку "Save draft"
2. Редактор валидирует данные
3. Если валидация успешна:
   - Преобразует блоки в YAML структуру
   - Отправляет запрос на сохранение
   - Показывает индикатор загрузки
   - После успешного сохранения показывает уведомление "Draft saved"
4. Если валидация не прошла:
   - Показывает список ошибок
   - Блокирует сохранение

**API Endpoint:**
```
PUT /api/course-editor/courses/{course_id}
```

**Request:**
```typescript
{
  course_id: string;
  title?: string;              // Для обновления в courses.yml
  description?: string;        // Для обновления в courses.yml
  blocks: Block[];             // Блоки для преобразования в YAML
  settings?: {                 // Дополнительные настройки для courses.yml
    element?: string;
    restricted?: boolean;
    decline_text?: string;
    ban_enabled?: boolean;
    ban_text?: string;
  };
}
```

**Процесс на сервере:**
1. Преобразует блоки в YAML формат
2. Сохраняет YAML файл курса по пути из `courses.yml`
3. Обновляет `courses.yml` если изменились метаданные курса
4. Возвращает подтверждение сохранения

**Response:**
```typescript
{
  course_id: string;
  path: string;
  saved_at: string;
  message: "Draft saved successfully";
}
```

**Обработка ошибок:**
- 404: Курс не найден в `courses.yml` → показать ошибку
- 403: Нет прав на редактирование → показать ошибку
- 400: Ошибка валидации YAML → показать ошибку с деталями
- 500: Ошибка записи файла → показать ошибку и предложить повторить
- 409: Файл заблокирован другим процессом → показать предупреждение

#### FR-7: Автосохранение (опционально)

**Описание:** Автоматическое сохранение изменений каждые N секунд.

**Требования:**
- Сохранение происходит в фоне без блокировки UI
- Показывать индикатор "Saving..." в заголовке
- Не сохранять, если нет изменений
- Не сохранять, если есть ошибки валидации

**Приоритет:** Средний (можно добавить в следующей итерации)

### 3.4 Предпросмотр курса

#### FR-8: Предпросмотр курса

**Описание:** По кнопке "Preview course" открывается предпросмотр курса.

**Требования:**
- Открывается в новой вкладке или модальном окне
- Показывает курс так, как его увидит студент
- Использует существующий компонент просмотра курса
- URL: `/courses/{course_id}/preview` или `/course-editor/{course_id}/preview`

**Приоритет:** Средний

---

## 4. Технические требования

### 4.1 API Endpoints

#### Список необходимых endpoints

**Загрузка курса:**
```
GET /api/course-editor/courses/{course_id}
```
- Читает `courses.yml` для получения пути к файлу
- Загружает YAML файл курса
- Возвращает метаданные и содержимое YAML

**Создание курса:**
```
POST /api/course-editor/courses
```
- Создает новый YAML файл курса
- Добавляет запись в `courses.yml`
- Возвращает `course_id` и путь к файлу

**Сохранение курса:**
```
PUT /api/course-editor/courses/{course_id}
```
- Преобразует блоки в YAML формат
- Сохраняет YAML файл курса
- Обновляет `courses.yml` если изменились метаданные

**Удаление курса (опционально):**
```
DELETE /api/course-editor/courses/{course_id}
```
- Удаляет YAML файл курса
- Удаляет запись из `courses.yml`

**Получение списка курсов:**
```
GET /api/course-editor/courses
```
- Читает `courses.yml`
- Возвращает список всех курсов с метаданными

### 4.2 Преобразование данных

#### Функция: YAML → Блоки редактора

```typescript
function convertYamlToBlocks(
  yamlContent: Record<string, any>
): Block[] {
  // 1. Проходим по всем ключам верхнего уровня (element_id)
  // 2. Для каждого элемента:
  //    - Определяем тип блока по полю type
  //    - Преобразуем поля YAML в поля блока
  //    - Создаем Block с соответствующими полями
  // 3. Сохраняем порядок элементов как в YAML файле
  // 4. Добавляем Section блоки для визуальной группировки (опционально)
  // 5. Возвращаем массив Block[]
}
```

**Пример преобразования:**

**YAML элементы:**

**Section:**
```yaml
Section_Intro:
  type: section
  title: Введение
```

**Quiz:**
```yaml
Test_Quiz_01:
  type: quiz
  text: Important (1/5)
  answers:
    - text: Viral
      feedback: Почти, но это не совсем то.
    - text: Essential
      correct: yes
      feedback: Отлично!
```

**Block (Редактор):**

**Section:**
```typescript
{
  id: "Section_Intro",
  type: "Section",
  title: "Введение"
}
```

**Quiz:**
```typescript
{
  id: "Test_Quiz_01",
  type: "Quiz",
  question: "Important (1/5)",
  answers: [
    {text: "Viral", correct: false},
    {text: "Essential", correct: true}
  ],
  parseMode: "TEXT",
  linkPreview: false
}
```

#### Функция: Блоки редактора → YAML

```typescript
function convertBlocksToYaml(
  blocks: Block[],
  courseMetadata?: {
    element?: string;
    restricted?: boolean;
    decline_text?: string;
    ban_enabled?: boolean;
    ban_text?: string;
  }
): {
  yamlContent: Record<string, any>;
  coursesYamlEntry: Record<string, any>;
} {
  // 1. Преобразуем каждый Block в YAML элемент:
  //    - Используем id блока как ключ элемента
  //    - Определяем type по типу блока (section, message, quiz, input, dialog)
  //    - Преобразуем поля блока в поля YAML элемента
  //    - Для Section: {type: section, title}
  //    - Сохраняем порядок блоков как порядок элементов в YAML
  // 2. Формируем структуру для courses.yml (если нужно)
  // 3. Возвращаем объект с yamlContent и coursesYamlEntry
}
```

**Примеры преобразования:**

**Section:**
```typescript
// Block (Редактор)
{
  id: "Section_Intro",
  type: "Section",
  title: "Введение"
}

// YAML элемент
Section_Intro:
  type: section
  title: Введение
```

**Message:**
```typescript
// Block (Редактор)
{
  id: "Test_Message_01",
  type: "Message",
  text: "Привет! Рад тебя видеть!",
  parseMode: "MARKDOWN",
  linkPreview: false
}

// YAML элемент
Test_Message_01:
  type: message
  text: |
    Привет! Рад тебя видеть!
```

**Особенности преобразования:**

1. **Сохранение форматирования:**
   - Многострочный текст сохраняется с `|` (literal block) для сохранения переносов строк
   - Короткий многострочный текст можно сохранять с `>` (folded block)
   - Комментарии в YAML можно сохранять (если они были) - требует специальной библиотеки
   - Сохранение отступов и структуры где возможно

2. **Порядок элементов:**
   - Порядок элементов в YAML соответствует порядку блоков в редакторе
   - При сохранении можно сохранить исходный порядок или отсортировать по ID
   - YAML не гарантирует порядок ключей, но большинство парсеров его сохраняют

3. **Обработка специальных символов:**
   - Экранирование специальных символов в YAML
   - Правильная обработка кавычек и переносов строк
   - Валидация ID элементов (допустимые символы для ключей YAML)

4. **Типы данных:**
   - Boolean значения: `true`/`false` или `yes`/`no` (в зависимости от контекста)
   - Числа сохраняются как числа, не строки
   - Массивы сохраняются в правильном формате YAML

### 4.3 Обработка состояний

#### Состояния редактора

1. **Loading** - загрузка курса из БД
2. **Editing** - редактирование курса
3. **Saving** - сохранение изменений
4. **Error** - ошибка загрузки/сохранения
5. **Dirty** - есть несохраненные изменения

#### Индикация состояний

- **Loading:** Показать skeleton loader или spinner
- **Saving:** Показать индикатор "Saving..." в заголовке
- **Dirty:** Показать предупреждение при попытке закрыть страницу
- **Error:** Показать toast с ошибкой и кнопкой "Retry"

### 4.4 Обработка конфликтов

#### Проблема: Одновременное редактирование

**Сценарий:** Два пользователя редактируют один курс одновременно.

**Решения:**

**Вариант 1: Optimistic locking (рекомендуется)**
- Добавить поле `version` или `updated_at` в Course
- При сохранении проверять, что версия не изменилась
- Если изменилась → показать предупреждение и предложить перезагрузить

**Вариант 2: Pessimistic locking**
- Блокировать курс при открытии редактора
- Освобождать блокировку при закрытии
- Сложнее в реализации, требует WebSocket или polling

**Рекомендация:** Начать с Варианта 1 для MVP.

---

## 5. Работа с файловой системой

### 5.1 Структура файлов

**Расположение файлов:**
- `scripts/{bot_folder}/courses.yml` - список всех курсов
- `scripts/{bot_folder}/*.yml` - файлы курсов
- `{bot_folder}` определяется из переменной окружения или конфигурации

**Формат `courses.yml`:**
```yaml
course_id:
  path: scripts/course_file.yml
  element: StartElement           # Опционально
  restricted: yes                 # Опционально
  decline_text: "..."             # Опционально
  ban_enabled: yes                # Опционально
  ban_text: "..."                 # Опционально
```

**Формат файла курса:**
```yaml
Element_ID:
  type: message
  text: "..."
  # ... другие поля
```

### 5.2 Операции с файлами

#### TR-1: Чтение файлов

**Требования:**
- Безопасное чтение YAML файлов с обработкой ошибок
- Валидация существования файлов перед чтением
- Обработка ошибок парсинга YAML (невалидный синтаксис)
- Кодировка UTF-8 для поддержки всех символов
- Обработка случая `path: "db"` в `courses.yml`:
  - Если курс имеет `path: "db"`, он хранится в базе данных
  - Редактор должен либо:
    a) Экспортировать курс из БД в YAML для редактирования
    b) Показать сообщение, что курс нельзя редактировать через редактор
    c) Поддержать редактирование курсов из БД (требует дополнительной реализации)

#### TR-2: Запись файлов

**Требования:**
- Атомарная запись файлов (создание временного файла, затем переименование)
- Резервное копирование перед перезаписью существующего файла
- Валидация YAML перед записью
- Сохранение форматирования где возможно (комментарии, порядок элементов)
- Обработка ошибок записи (недостаточно прав, диск заполнен)

#### TR-3: Обновление courses.yml

**Требования:**
- Безопасное обновление `courses.yml` без потери других записей
- Сохранение комментариев и форматирования
- Валидация структуры перед записью
- Обработка конфликтов при одновременном редактировании

### 5.3 Обработка ошибок файловой системы

**Типы ошибок:**
- Файл не найден → 404
- Нет прав на чтение/запись → 403
- Диск заполнен → 507 (Insufficient Storage)
- Файл заблокирован другим процессом → 409 (Conflict)
- Ошибка парсинга YAML → 400 (Bad Request)
- Ошибка записи → 500 (Internal Server Error)

## 6. Безопасность и авторизация

### 6.1 Проверка прав доступа

#### TR-1: Проверка прав на редактирование

**Требования:**
- Только создатель курса (`creator_id`) может редактировать курс
- Администраторы могут редактировать любые курсы
- Остальные пользователи получают 403 при попытке редактирования

**Реализация:**
- Проверка на backend при каждом запросе
- Frontend проверяет права при загрузке курса
- Показывает сообщение об ошибке, если нет прав

**Примечание:** Для курсов в файловой системе права могут определяться через:
- Владельца файла (Unix permissions)
- Дополнительную таблицу в БД с правами доступа
- Конфигурацию в `courses.yml` (если добавить поле `creator_id`)

### 6.2 Валидация данных

#### TR-2: Валидация на сервере

**Требования:**
- Все данные валидируются на сервере перед сохранением
- Использовать Zod схемы или Pydantic модели
- Валидация структуры YAML перед записью
- Возвращать понятные сообщения об ошибках

#### TR-3: Санитизация контента

**Требования:**
- Санитизировать HTML контент для предотвращения XSS
- Валидировать URL медиафайлов
- Ограничивать размер текстовых полей
- Валидировать ID элементов (допустимые символы для ключей YAML)

### 6.3 Защита файловой системы

#### TR-4: Защита от path traversal

**Требования:**
- Валидация путей к файлам курсов
- Запрет на использование `..` в путях
- Ограничение путей только директорией `scripts/{bot_folder}/`
- Нормализация путей перед использованием

#### TR-5: Резервное копирование

**Требования:**
- Создание backup перед перезаписью существующего файла
- Хранение последних N версий файлов
- Возможность восстановления из backup

---

## 7. План реализации

### Фаза 1: Базовая интеграция (MVP)

**Цель:** Редактор может загружать и сохранять курс в YAML файлы.

**Задачи:**

1. **Backend:**
   - [ ] Реализовать `GET /api/course-editor/courses/{course_id}`
     - Чтение `courses.yml` для получения пути к файлу
     - Загрузка YAML файла курса
     - Парсинг YAML в структуру данных
   - [ ] Реализовать `PUT /api/course-editor/courses/{course_id}`
     - Преобразование блоков в YAML формат
     - Сохранение YAML файла курса
     - Обновление `courses.yml` при необходимости
   - [ ] Реализовать `POST /api/course-editor/courses` (создание)
     - Генерация `course_id` или использование переданного
     - Создание нового YAML файла курса
     - Добавление записи в `courses.yml`
   - [ ] Добавить функции преобразования YAML ↔ Блоки
     - Поддержка 5 типов: Section (`section`), Message (`message`), Quiz (`quiz`), Input (`input`), Dialog (`dialog`)
     - Правильная обработка всех полей для каждого типа
     - Section сохраняется как `{type: section, title: "..."}` в YAML
   - [ ] Добавить валидацию YAML данных
   - [ ] Добавить проверку прав доступа
   - [ ] Добавить обработку ошибок файловой системы

2. **Frontend:**
   - [ ] Добавить загрузку курса по `course_id` из URL
   - [ ] Реализовать преобразование YAML → Блоки при загрузке
   - [ ] Реализовать преобразование Блоки → YAML при сохранении
   - [ ] Подключить кнопку "Save draft" к API
   - [ ] Добавить обработку состояний (loading, saving, error)
   - [ ] Добавить валидацию перед сохранением
   - [ ] Добавить обработку ошибок (файл не найден, ошибка парсинга и т.д.)

**Оценка:** 2-3 недели

### Фаза 2: Улучшения UX

**Цель:** Улучшить пользовательский опыт редактирования.

**Задачи:**

1. **Автосохранение:**
   - [ ] Реализовать автосохранение каждые 30 секунд
   - [ ] Показывать индикатор "Saving..."
   - [ ] Предупреждать о несохраненных изменениях

2. **Предпросмотр:**
   - [ ] Реализовать кнопку "Preview course"
   - [ ] Открывать предпросмотр в новой вкладке

3. **Обработка конфликтов:**
   - [ ] Добавить optimistic locking
   - [ ] Показывать предупреждение при конфликте версий

**Оценка:** 1-2 недели

### Фаза 3: Расширенная функциональность

**Цель:** Добавить продвинутые функции и дополнительные типы элементов.

**Задачи:**

1. **Поддержка дополнительных типов элементов:**
   - [ ] Добавить поддержку `audio` (аудиосообщения)
   - [ ] Добавить поддержку `question` (опросы без правильного ответа)
   - [ ] Добавить поддержку `multi_choice` (множественный выбор)
   - [ ] Добавить поддержку `test` (итоговые тесты)
   - [ ] Добавить поддержку `jump` (навигация)
   - [ ] Добавить поддержку `revision` (повторение ошибок)
   - [ ] Добавить поддержку `delay` (задержка)
   - [ ] Добавить поддержку `end` (завершение курса)
   - [ ] Реализовать преобразование для каждого типа
   - [ ] Добавить UI для редактирования каждого типа

2. **Иерархическая структура:**
   - [ ] Поддержка преобразования Section → комментарии в YAML или группировка
   - [ ] Визуальная группировка элементов по секциям

3. **История изменений:**
   - [ ] Сохранение версий YAML файлов (backup)
   - [ ] Просмотр истории изменений
   - [ ] Откат к предыдущей версии

4. **Улучшения YAML:**
   - [ ] Сохранение комментариев в YAML файлах
   - [ ] Сохранение форматирования (многострочный текст с `|` или `>`)
   - [ ] Оптимизация порядка элементов в YAML

**Оценка:** 2-3 недели

---

## 8. Тестирование

### 7.1 Unit тесты

**Что тестировать:**
- Функции преобразования YAML ↔ Блоки
- Валидация данных блоков
- Обработка ошибок парсинга YAML
- Генерация валидного YAML из блоков

### 7.2 Integration тесты

**Что тестировать:**
- Загрузка курса из YAML файла
- Сохранение курса в YAML файл
- Обновление `courses.yml`
- Обработка ошибок API (файл не найден, ошибка парсинга)
- Проверка прав доступа

### 7.3 E2E тесты

**Сценарии:**
1. Создание нового курса
   - Создание YAML файла
   - Добавление записи в `courses.yml`
2. Загрузка существующего курса
   - Чтение `courses.yml`
   - Загрузка YAML файла
   - Преобразование в блоки
3. Редактирование блоков
   - Добавление, удаление, изменение порядка
4. Сохранение изменений
   - Преобразование блоков в YAML
   - Сохранение файла
5. Обработка ошибок (нет прав, курс не найден, ошибка парсинга YAML)

---

## 9. Документация

### 9.1 Техническая документация

- [ ] Описание API endpoints
- [ ] Схемы данных (Zod/Pydantic)
- [ ] Примеры запросов/ответов
- [ ] Описание преобразования YAML ↔ Блоки
- [ ] Примеры работы с YAML файлами
- [ ] Описание формата `courses.yml`

### 9.2 Пользовательская документация

- [ ] Руководство по использованию редактора
- [ ] Описание типов блоков
- [ ] Примеры создания курсов
- [ ] Инструкции по работе с YAML файлами

---

## 10. Риски и ограничения

### 10.1 Риски

1. **Потеря данных при сохранении**
   - **Митигация:** Резервное копирование перед перезаписью, предупреждение о несохраненных изменениях

2. **Конфликты при одновременном редактировании**
   - **Митигация:** Проверка времени модификации файла, предупреждения

3. **Производительность при большом количестве блоков**
   - **Митигация:** Виртуализация списка, пагинация

4. **Несовместимость типов блоков**
   - **Митигация:** Валидация при преобразовании, понятные сообщения об ошибках

5. **Потеря форматирования YAML**
   - **Митигация:** Использование библиотек, сохраняющих форматирование (ruamel.yaml для Python)

6. **Ошибки файловой системы**
   - **Митигация:** Обработка всех типов ошибок, понятные сообщения пользователю

### 10.2 Ограничения MVP

**Поддерживаемые типы элементов (5 типов):**
- ✅ Section (`type: section`) - разделитель секций с полем `title`
- ✅ Message (`type: message`) - текстовые сообщения
- ✅ Quiz (`type: quiz`) - викторины с вариантами ответов
- ✅ Input (`type: input`) - поля ввода текста
- ✅ Dialog (`type: dialog`) - диалоги с ИИ-ассистентом

**Не поддерживаются в MVP:**
- ❌ Audio (`type: audio`)
- ❌ Question (`type: question`)
- ❌ MultiChoice (`type: multi_choice`)
- ❌ Test (`type: test`)
- ❌ Jump (`type: jump`)
- ❌ Revision (`type: revision`)
- ❌ Delay (`type: delay`)
- ❌ End (`type: end`)

**Другие ограничения:**
- Комментарии в YAML могут теряться при сохранении
- Форматирование YAML может изменяться (многострочный текст может измениться)
- Курсы с `path: "db"` в `courses.yml` не могут быть отредактированы (требуют экспорта в YAML)
- Нет истории изменений
- Нет автосохранения
- Нет предпросмотра

### 10.3 Работа с курсами из БД

**Проблема:** Некоторые курсы хранятся в базе данных (`path: "db"` в `courses.yml`), а не в YAML файлах.

**Варианты решения:**

**Вариант 1: Экспорт в YAML (рекомендуется для MVP)**
- При попытке открыть курс с `path: "db"` показать сообщение
- Предложить экспортировать курс из БД в YAML файл
- После экспорта курс можно редактировать через редактор
- При сохранении курс сохраняется в YAML, но не обновляется в БД

**Вариант 2: Поддержка редактирования курсов из БД**
- Редактор может работать с курсами из БД напрямую
- При сохранении обновляется БД вместо YAML файла
- Требует реализации преобразования БД ↔ Блоки (как в версии 1.0 документа)
- Более сложная реализация

**Рекомендация:** Начать с Варианта 1 для MVP, затем добавить поддержку Варианта 2 при необходимости.

---

## 11. Критерии приемки

Редактор считается готовым к production (MVP), если:

1. ✅ Можно загрузить существующий курс по `course_id` из YAML файла
2. ✅ Можно создать новый курс (создается YAML файл и запись в `courses.yml`)
3. ✅ Можно редактировать все 5 типов блоков: Section, Message, Quiz, Input, Dialog
4. ✅ Можно сохранить изменения по кнопке "Save draft" (сохраняется в YAML файл)
5. ✅ Данные корректно преобразуются между YAML и блоками редактора для всех 5 типов
6. ✅ Валидация работает на клиенте и сервере
7. ✅ Обработка ошибок работает корректно (файл не найден, ошибка парсинга и т.д.)
8. ✅ Проверка прав доступа работает
9. ✅ UI показывает состояния загрузки/сохранения
10. ✅ Нет потери данных при сохранении
11. ✅ YAML файлы сохраняются в правильном формате и читаются корректно
12. ✅ `courses.yml` корректно обновляется при создании/изменении курсов
13. ✅ Section блоки корректно сохраняются в YAML как `{type: section, title: "..."}`

---

## 12. Пример курса

Полный пример YAML файла курса с всеми 5 типами элементов находится в файле:
- `docs/reqs/course_editor_example_course.yml`

Пример демонстрирует:
- Section элементы для организации структуры
- Message элементы с текстом, кнопками и форматированием
- Quiz элементы с вариантами ответов
- Input элементы для ввода текста и последовательностей
- Dialog элементы для диалогов с ИИ

---

## 13. Связанные документы

- `docs/prototypes/course_editor/` - Прототип редактора
- `docs/reqs/course_visual_editor_vision.md` - Видение визуального редактора
- `docs/elements.md` - Документация по типам элементов
- `docs/database.md` - Структура базы данных
- `docs/reqs/webversion_prd.md` - PRD веб-версии
- `docs/reqs/course_editor_example_course.yml` - Пример курса с 5 типами элементов
- `webapp/frontend/components/course-editor/CourseEditor.tsx` - Компонент редактора

---

## 14. История изменений

| Версия | Дата | Автор | Описание |
|--------|------|-------|----------|
| 1.0 | 2024-12 | - | Первоначальная версия требований (работа с БД) |
| 2.0 | 2024-12 | - | Переработано для работы с YAML файлами вместо БД |
